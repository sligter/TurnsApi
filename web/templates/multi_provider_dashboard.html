<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{.title}}</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <script src="https://cdn.tailwindcss.com"></script>
        <script
            src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
            defer
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            [x-cloak] {
                display: none !important;
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen">
        <div
            class="container mx-auto px-4 py-8"
            x-data="multiProviderDashboard()"
        >
            <!-- Header -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        TurnsAPI 仪表板
                    </h1>
                    <p class="text-gray-600">管理多个AI提供商的密钥</p>
                </div>
                <div class="flex space-x-4">
                    <a
                        href="/"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        返回首页
                    </a>
                    <a
                        href="/logs"
                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        请求日志
                    </a>
                    <button
                        @click="refreshData()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        刷新数据
                    </button>
                    <button
                        onclick="logout()"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        登出
                    </button>
                </div>
            </div>

            <!-- System Overview - 第一排 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- 系统状态 -->
                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div
                                    class="w-12 h-12 rounded-lg flex items-center justify-center bg-green-100"
                                >
                                    <svg
                                        class="w-6 h-6 text-green-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">
                                    系统状态
                                </p>
                                <p class="text-xl font-bold text-green-600">
                                    运行中
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button
                                @click="refreshAllHealth()"
                                :disabled="loadingHealthRefresh"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 transition-all duration-200"
                            >
                                <svg
                                    x-show="!loadingHealthRefresh"
                                    class="w-3 h-3 mr-1"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                                    ></path>
                                </svg>
                                <svg
                                    x-show="loadingHealthRefresh"
                                    class="animate-spin w-3 h-3 mr-1"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <circle
                                        class="opacity-25"
                                        cx="12"
                                        cy="12"
                                        r="10"
                                        stroke="currentColor"
                                        stroke-width="4"
                                    ></circle>
                                    <path
                                        class="opacity-75"
                                        fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    ></path>
                                </svg>
                                <span x-show="!loadingHealthRefresh"
                                    >健康检查</span
                                >
                                <span x-show="loadingHealthRefresh"
                                    >检查中</span
                                >
                            </button>
                            <button
                                @click="loadSystemHealth()"
                                :disabled="loadingSystemHealth"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 transition-all duration-200"
                            >
                                <svg
                                    x-show="!loadingSystemHealth"
                                    class="w-3 h-3 mr-1"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    ></path>
                                </svg>
                                <svg
                                    x-show="loadingSystemHealth"
                                    class="animate-spin w-3 h-3 mr-1"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <circle
                                        class="opacity-25"
                                        cx="12"
                                        cy="12"
                                        r="10"
                                        stroke="currentColor"
                                        stroke-width="4"
                                    ></circle>
                                    <path
                                        class="opacity-75"
                                        fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    ></path>
                                </svg>
                                <span x-show="!loadingSystemHealth">刷新</span>
                                <span x-show="loadingSystemHealth">刷新中</span>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">CPU使用率</span>
                            <span
                                class="font-medium"
                                x-text="formatPercentage(systemHealth.cpu_usage)"
                                >0%</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">内存使用</span>
                            <span
                                class="font-medium"
                                x-text="formatPercentage(systemHealth.memory_usage)"
                                >0%</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">启动时间</span>
                            <span
                                class="font-medium"
                                x-text="formatDuration(systemHealth.uptime)"
                                >-</span
                            >
                        </div>
                    </div>
                </div>

                <!-- 提供商分组 -->
                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div
                                    class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"
                                >
                                    <svg
                                        class="w-6 h-6 text-blue-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">
                                    提供商分组
                                </p>
                                <p
                                    class="text-xl font-bold text-blue-600"
                                    x-text="systemHealth.total_groups || 0"
                                ></p>
                            </div>
                        </div>
                        <button
                            @click="loadProviderStatuses()"
                            :disabled="loadingProviderStatuses"
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 transition-all duration-200"
                        >
                            <svg
                                x-show="!loadingProviderStatuses"
                                class="w-3 h-3 mr-1"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                ></path>
                            </svg>
                            <svg
                                x-show="loadingProviderStatuses"
                                class="animate-spin w-3 h-3 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                            >
                                <circle
                                    class="opacity-25"
                                    cx="12"
                                    cy="12"
                                    r="10"
                                    stroke="currentColor"
                                    stroke-width="4"
                                ></circle>
                                <path
                                    class="opacity-75"
                                    fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                ></path>
                            </svg>
                            <span x-show="!loadingProviderStatuses">刷新</span>
                            <span x-show="loadingProviderStatuses">刷新中</span>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">启用分组</span>
                            <span
                                class="font-medium text-green-600"
                                x-text="systemHealth.enabled_groups || 0"
                                >0</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">禁用分组</span>
                            <span
                                class="font-medium text-red-600"
                                x-text="systemHealth.disabled_groups || 0"
                                >0</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">总密钥数</span>
                            <span
                                class="font-medium"
                                x-text="systemHealth.total_keys || 0"
                                >0</span
                            >
                        </div>
                    </div>
                </div>

                <!-- 运行时间 -->
                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200"
                >
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div
                                    class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center"
                                >
                                    <svg
                                        class="w-6 h-6 text-orange-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">
                                    运行时间
                                </p>
                                <p
                                    class="text-xl font-bold text-orange-600"
                                    x-text="formatDuration(systemHealth.uptime)"
                                ></p>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">启动时间</span>
                            <span
                                class="font-medium"
                                x-text="formatDate(systemHealth.start_time)"
                                >-</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">版本信息</span>
                            <span
                                class="font-medium"
                                x-text="systemHealth.version || 'v2.2.0'"
                                >v2.2.0</span
                            >
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">请求总数</span>
                            <span
                                class="font-medium"
                                x-text="systemHealth.total_requests || 0"
                                >0</span
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- API密钥状态 - 第二排 -->
            <div class="mb-8">
                <div
                    class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-all duration-200"
                >
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div
                                    class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"
                                >
                                    <svg
                                        class="w-6 h-6 text-purple-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2h4zm-6 2v6h4V9H9z"
                                        ></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-lg font-semibold text-gray-800">
                                    API密钥状态
                                </p>
                                <p
                                    class="text-sm text-gray-500"
                                    x-show="keyStatus.last_updated"
                                >
                                    更新于
                                    <span
                                        x-text="keyStatus.last_updated"
                                    ></span>
                                </p>
                                <p
                                    class="text-sm text-gray-400"
                                    x-show="!keyStatus.last_updated"
                                >
                                    点击"手动检测"获取最新状态
                                </p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button
                                @click="refreshKeyStatus()"
                                :disabled="loadingKeyStatus"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 transition-all duration-200"
                            >
                                <svg
                                    x-show="!loadingKeyStatus"
                                    class="w-4 h-4 mr-2"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    ></path>
                                </svg>
                                <svg
                                    x-show="loadingKeyStatus"
                                    class="animate-spin w-4 h-4 mr-2"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <circle
                                        class="opacity-25"
                                        cx="12"
                                        cy="12"
                                        r="10"
                                        stroke="currentColor"
                                        stroke-width="4"
                                    ></circle>
                                    <path
                                        class="opacity-75"
                                        fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    ></path>
                                </svg>
                                <span x-show="!loadingKeyStatus">实时状态</span>
                                <span x-show="loadingKeyStatus">获取中...</span>
                            </button>
                            <button
                                @click="loadPersistedValidationStatus()"
                                :disabled="loadingValidation"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 transition-all duration-200"
                            >
                                <svg
                                    x-show="!loadingValidation"
                                    class="w-4 h-4 mr-2"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                                <svg
                                    x-show="loadingValidation"
                                    class="animate-spin w-4 h-4 mr-2"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <circle
                                        class="opacity-25"
                                        cx="12"
                                        cy="12"
                                        r="10"
                                        stroke="currentColor"
                                        stroke-width="4"
                                    ></circle>
                                    <path
                                        class="opacity-75"
                                        fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    ></path>
                                </svg>
                                <span x-show="!loadingValidation"
                                    >检查所有密钥</span
                                >
                                <span x-show="loadingValidation"
                                    >检查中...</span
                                >
                            </button>
                        </div>
                    </div>

                    <!-- 密钥统计 -->
                    <div class="grid grid-cols-3 gap-8">
                        <div class="text-center">
                            <div
                                class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3"
                            >
                                <div
                                    class="w-6 h-6 bg-green-500 rounded-full"
                                ></div>
                            </div>
                            <div
                                class="text-2xl font-bold text-green-600 mb-1"
                                x-text="keyStatus.total_valid || 0"
                            >
                                0
                            </div>
                            <div class="text-sm text-gray-500">有效密钥</div>
                        </div>
                        <div class="text-center">
                            <div
                                class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3"
                            >
                                <div
                                    class="w-6 h-6 bg-red-500 rounded-full"
                                ></div>
                            </div>
                            <div
                                class="text-2xl font-bold text-red-600 mb-1"
                                x-text="keyStatus.total_invalid || 0"
                            >
                                0
                            </div>
                            <div class="text-sm text-gray-500">无效密钥</div>
                        </div>
                        <div class="text-center">
                            <div
                                class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3"
                            >
                                <div
                                    class="w-6 h-6 bg-gray-500 rounded-full"
                                ></div>
                            </div>
                            <div
                                class="text-2xl font-bold text-gray-600 mb-1"
                                x-text="keyStatus.total_keys || 0"
                            >
                                0
                            </div>
                            <div class="text-sm text-gray-500">总计</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provider Groups Status -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">提供商分组状态</h2>
                    <div class="flex space-x-2">
                        <button
                            @click="openCreateGroupModal()"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center"
                        >
                            <svg
                                class="w-4 h-4 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                ></path>
                            </svg>
                            添加分组
                        </button>
                        <button
                            @click="exportGroups()"
                            class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center"
                        >
                            <svg
                                class="w-4 h-4 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                ></path>
                            </svg>
                            导出配置
                        </button>
                        <button
                            @click="showImportModal = true"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center"
                        >
                            <svg
                                class="w-4 h-4 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"
                                ></path>
                            </svg>
                            导入配置
                        </button>
                        <button
                            @click="refreshProviderHealth()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-200"
                        >
                            刷新健康状态
                        </button>
                    </div>
                </div>

                <!-- 密钥状态图例 -->
                <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700"
                            >密钥状态图例：</span
                        >
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center space-x-2">
                                <div
                                    class="w-2 h-2 bg-green-500 rounded-full"
                                ></div>
                                <span class="text-xs text-gray-600">有效</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div
                                    class="w-2 h-2 bg-red-500 rounded-full"
                                ></div>
                                <span class="text-xs text-gray-600">无效</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div
                                    class="w-2 h-2 bg-gray-400 rounded-full"
                                ></div>
                                <span class="text-xs text-gray-600"
                                    >未检测</span
                                >
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 搜索和筛选 -->
                <div class="mb-6 flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <div class="relative">
                            <input
                                type="text"
                                x-model="providerSearchQuery"
                                @input="filterProviders()"
                                placeholder="搜索分组名称或提供商类型..."
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <svg
                                class="absolute left-3 top-2.5 h-5 w-5 text-gray-400"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                ></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <select
                            x-model="providerStatusFilter"
                            @change="filterProviders()"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">所有状态</option>
                            <option value="healthy">健康</option>
                            <option value="unhealthy">异常</option>
                        </select>
                        <select
                            x-model="providerTypeFilter"
                            @change="filterProviders()"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">所有类型</option>
                            <option value="openai">OpenAI</option>
                            <option value="azure_openai">Azure OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="gemini">Google Gemini</option>
                            <option value="openrouter">OpenRouter</option>
                        </select>
                    </div>
                </div>

                <!-- 提供商列表 -->
                <div class="space-y-4">
                    <template
                        x-for="(provider, groupId) in paginatedProviders"
                        :key="groupId"
                    >
                        <div
                            class="border rounded-lg p-4 hover:shadow-md transition-shadow"
                            :class="provider.healthy ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'"
                        >
                            <div class="flex items-center justify-between">
                                <!-- 左侧信息 -->
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <input
                                            type="checkbox"
                                            :value="groupId"
                                            x-model="selectedGroups"
                                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
                                        />
                                        <div
                                            class="w-3 h-3 rounded-full mr-2"
                                            :class="provider.healthy ? 'bg-green-500' : 'bg-red-500'"
                                        ></div>
                                        <div>
                                            <h3
                                                class="font-semibold text-gray-900"
                                                x-text="provider.group_name"
                                            ></h3>
                                            <p
                                                class="text-sm text-gray-500"
                                                x-text="groupId"
                                            ></p>
                                        </div>
                                    </div>

                                    <span
                                        class="text-xs px-2 py-1 rounded-full"
                                        :class="getProviderTypeClass(provider.provider_type)"
                                        x-text="provider.provider_type.toUpperCase()"
                                    ></span>

                                    <!-- 状态信息 -->
                                    <div
                                        class="flex items-center space-x-4 text-sm"
                                    >
                                        <div
                                            class="flex items-center space-x-1"
                                        >
                                            <span class="text-gray-600"
                                                >状态:</span
                                            >
                                            <span
                                                :class="provider.enabled !== false ? 'text-green-600' : 'text-gray-500'"
                                                x-text="provider.enabled !== false ? '启用' : '禁用'"
                                            ></span>
                                        </div>
                                        <div
                                            class="flex items-center space-x-1"
                                        >
                                            <span class="text-gray-600"
                                                >密钥:</span
                                            >
                                            <div
                                                class="flex items-center space-x-2"
                                            >
                                                <!-- 总计 -->
                                                <span
                                                    class="text-gray-900 font-medium"
                                                    x-text="getKeyStatusData(groupId, provider).total"
                                                ></span>

                                                <!-- 有效密钥 -->
                                                <div
                                                    class="flex items-center space-x-1"
                                                >
                                                    <div
                                                        class="w-2 h-2 bg-green-500 rounded-full"
                                                    ></div>
                                                    <span
                                                        class="text-green-600 text-xs font-medium"
                                                        x-text="getKeyStatusData(groupId, provider).valid"
                                                    ></span>
                                                </div>

                                                <!-- 无效密钥 -->
                                                <div
                                                    class="flex items-center space-x-1"
                                                    x-show="getKeyStatusData(groupId, provider).invalid > 0"
                                                >
                                                    <div
                                                        class="w-2 h-2 bg-red-500 rounded-full"
                                                    ></div>
                                                    <span
                                                        class="text-red-600 text-xs font-medium"
                                                        x-text="getKeyStatusData(groupId, provider).invalid"
                                                    ></span>
                                                </div>

                                                <!-- 未检测 -->
                                                <div
                                                    class="flex items-center space-x-1"
                                                    x-show="getKeyStatusData(groupId, provider).unknown > 0"
                                                >
                                                    <div
                                                        class="w-2 h-2 bg-gray-400 rounded-full"
                                                    ></div>
                                                    <span
                                                        class="text-gray-500 text-xs font-medium"
                                                        x-text="getKeyStatusData(groupId, provider).unknown"
                                                    ></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 右侧操作 -->
                                <div class="flex items-center space-x-2">
                                    <button
                                        @click="validateGroupKeys(groupId, provider)"
                                        :disabled="validatingGroups[groupId]"
                                        class="inline-flex items-center px-3 py-1 border border-purple-300 text-sm font-medium rounded text-purple-700 bg-purple-50 hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50 transition-colors"
                                    >
                                        <svg
                                            x-show="!validatingGroups[groupId]"
                                            class="w-4 h-4 mr-1"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                        </svg>
                                        <svg
                                            x-show="validatingGroups[groupId]"
                                            class="animate-spin w-4 h-4 mr-1"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                        >
                                            <circle
                                                class="opacity-25"
                                                cx="12"
                                                cy="12"
                                                r="10"
                                                stroke="currentColor"
                                                stroke-width="4"
                                            ></circle>
                                            <path
                                                class="opacity-75"
                                                fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                            ></path>
                                        </svg>
                                        <span
                                            x-show="!validatingGroups[groupId]"
                                            >检测</span
                                        >
                                        <span x-show="validatingGroups[groupId]"
                                            >检测中</span
                                        >
                                    </button>
                                    <button
                                        @click="editGroup(groupId, provider)"
                                        class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-1"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                            ></path>
                                        </svg>
                                        编辑
                                    </button>
                                    <button
                                        @click="toggleGroup(groupId, provider)"
                                        class="inline-flex items-center px-3 py-1 text-sm font-medium rounded"
                                        :class="provider.enabled !== false ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-green-500 hover:bg-green-600 text-white'"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-1"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                x-show="provider.enabled !== false"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                            <path
                                                x-show="provider.enabled === false"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                        </svg>
                                        <span
                                            x-text="provider.enabled !== false ? '禁用' : '启用'"
                                        ></span>
                                    </button>
                                    <button
                                        @click="deleteGroup(groupId, provider)"
                                        class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-1"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            ></path>
                                        </svg>
                                        删除
                                    </button>
                                </div>
                            </div>

                            <!-- 错误信息 -->
                            <div
                                x-show="provider.last_error"
                                class="mt-3 p-2 bg-red-100 border border-red-200 rounded text-sm text-red-700"
                            >
                                <strong>错误:</strong>
                                <span x-text="provider.last_error"></span>
                            </div>
                        </div>
                    </template>

                    <!-- 空状态 -->
                    <div
                        x-show="Object.keys(filteredProviders).length === 0"
                        class="text-center py-8"
                    >
                        <svg
                            class="mx-auto h-12 w-12 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                            ></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">
                            没有找到匹配的提供商
                        </h3>
                        <p class="mt-1 text-sm text-gray-500">
                            尝试调整搜索条件或筛选器
                        </p>
                    </div>
                </div>

                <!-- 分页控制 -->
                <div
                    x-show="totalProviderPages > 1"
                    class="mt-6 flex items-center justify-between"
                >
                    <div class="text-sm text-gray-700">
                        显示 <span x-text="providerPageOffset + 1"></span>-<span
                            x-text="Math.min(providerPageOffset + providersPerPage, Object.keys(filteredProviders).length)"
                        ></span>
                        共
                        <span
                            x-text="Object.keys(filteredProviders).length"
                        ></span>
                        个分组
                    </div>
                    <div class="flex space-x-1">
                        <button
                            @click="providerPage = Math.max(1, providerPage - 1)"
                            :disabled="providerPage <= 1"
                            class="px-3 py-2 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                        >
                            上一页
                        </button>
                        <span
                            class="px-3 py-2 text-sm border-t border-b"
                            x-text="providerPage + ' / ' + totalProviderPages"
                        ></span>
                        <button
                            @click="providerPage = Math.min(totalProviderPages, providerPage + 1)"
                            :disabled="providerPage >= totalProviderPages"
                            class="px-3 py-2 text-sm border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                        >
                            下一页
                        </button>
                    </div>
                </div>
            </div>

            <!-- Provider Models -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">支持的模型</h2>
                    <div class="flex space-x-2">
                        <select
                            x-model="selectedProvider"
                            @change="loadProviderModels()"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">所有提供商</option>
                            <template
                                x-for="(provider, groupId) in providerStatuses"
                                :key="groupId"
                            >
                                <option
                                    :value="groupId"
                                    x-text="provider.group_name"
                                ></option>
                            </template>
                        </select>
                        <button
                            @click="loadProviderModels()"
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200"
                        >
                            加载模型
                        </button>
                    </div>
                </div>

                <div x-show="loadingModels" class="text-center py-8">
                    <div
                        class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"
                    ></div>
                    <p class="mt-2 text-gray-600">加载模型中...</p>
                </div>

                <div
                    x-show="!loadingModels && Object.keys(providerModels).length > 0"
                    class="space-y-4"
                >
                    <template
                        x-for="(models, groupId) in providerModels"
                        :key="groupId"
                    >
                        <div class="border rounded-lg p-4">
                            <h3
                                class="font-semibold text-gray-900 mb-3"
                                x-text="models.group_name + ' (' + models.provider_type + ')'"
                            ></h3>
                            <div
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2"
                            >
                                <template
                                    x-for="model in (models.models && models.models.data ? models.models.data : [])"
                                    :key="model.id"
                                >
                                    <div
                                        class="bg-gray-100 px-3 py-2 rounded text-sm"
                                    >
                                        <span
                                            class="font-mono"
                                            x-text="model.id"
                                        ></span>
                                        <span
                                            x-show="model.owned_by"
                                            class="text-gray-500 ml-2"
                                            x-text="'(' + model.owned_by + ')'"
                                        ></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <div
                    x-show="!loadingModels && Object.keys(providerModels).length === 0"
                    class="text-center py-8 text-gray-500"
                >
                    <p>暂无模型数据，请选择提供商并点击加载模型</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-6">快速操作</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button
                        @click="showProxyKeyModal = true; loadProxyKeys()"
                        class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        代理密钥管理
                    </button>
                    <button
                        @click="exportHealthReport()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        导出健康报告
                    </button>
                    <button
                        @click="viewSystemLogs()"
                        class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-200"
                    >
                        查看请求日志
                    </button>
                </div>
                <div class="mt-4 text-sm text-gray-500">
                    最后更新: <span x-text="formatDate(lastUpdate)"></span>
                </div>
            </div>

            <!-- Group Management Modal -->
            <div
                x-show="showCreateGroupModal || showEditGroupModal"
                x-cloak
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                @click.self="closeGroupModal()"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
            >
                <div
                    class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col"
                >
                    <!-- 头部 -->
                    <div
                        class="flex justify-between items-center p-6 border-b border-gray-200"
                    >
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"
                            >
                                <svg
                                    class="w-4 h-4 text-blue-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                                    ></path>
                                </svg>
                            </div>
                            <div>
                                <h3
                                    class="text-xl font-bold text-gray-900"
                                    x-text="showCreateGroupModal ? '添加提供商分组' : '编辑提供商分组'"
                                ></h3>
                                <p
                                    class="text-sm text-gray-500"
                                    x-text="showCreateGroupModal ? '配置新的API提供商分组' : '修改现有提供商分组配置'"
                                ></p>
                            </div>
                        </div>
                        <button
                            @click="closeGroupModal()"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                ></path>
                            </svg>
                        </button>
                    </div>

                    <!-- 内容区域 -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <form
                            id="groupForm"
                            @submit.prevent="submitGroupForm()"
                            class="space-y-8"
                        >
                            <!-- 基本信息区域 -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <div class="flex items-center space-x-2 mb-4">
                                    <svg
                                        class="w-5 h-5 text-blue-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                    <h4
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        基本信息
                                    </h4>
                                </div>
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-6"
                                >
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >分组ID *</label
                                        >
                                        <input
                                            type="text"
                                            x-model="groupFormData.group_id"
                                            :disabled="showEditGroupModal"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            required
                                            placeholder="如: openai-group"
                                        />
                                        <p class="text-xs text-gray-500 mt-1">
                                            唯一标识符，创建后不可修改
                                        </p>
                                    </div>

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >分组名称 *</label
                                        >
                                        <input
                                            type="text"
                                            x-model="groupFormData.name"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            required
                                            placeholder="如: OpenAI 官方"
                                        />
                                        <p class="text-xs text-gray-500 mt-1">
                                            用于显示的友好名称
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- 提供商配置区域 -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <div class="flex items-center space-x-2 mb-4">
                                    <svg
                                        class="w-5 h-5 text-green-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                        ></path>
                                    </svg>
                                    <h4
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        提供商配置
                                    </h4>
                                </div>
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-6"
                                >
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >提供商类型 *</label
                                        >
                                        <select
                                            x-model="groupFormData.provider_type"
                                            @change="onProviderTypeChange()"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            required
                                        >
                                            <option value="">
                                                请选择提供商类型
                                            </option>
                                            <option value="openai">
                                                OpenAI
                                            </option>
                                            <option value="azure_openai">
                                                Azure OpenAI
                                            </option>
                                            <option value="anthropic">
                                                Anthropic
                                            </option>
                                            <option value="gemini">
                                                Google Gemini
                                            </option>
                                            <option value="openrouter">
                                                OpenRouter
                                            </option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">
                                            选择API提供商类型
                                        </p>
                                    </div>

                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >Base URL *</label
                                        >
                                        <input
                                            type="url"
                                            x-model="groupFormData.base_url"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            required
                                            placeholder="如: https://api.openai.com/v1"
                                        />
                                        <p class="text-xs text-gray-500 mt-1">
                                            API服务的基础URL地址
                                        </p>
                                        <p class="text-xs text-blue-500 mt-1" x-show="groupFormData.provider_type === 'azure_openai'">
                                            Azure格式: https://{resource}.openai.azure.com/openai/deployments/{deployment-name}
                                        </p>
                                    </div>

                                    <!-- Azure OpenAI API Version -->
                                    <div x-show="groupFormData.provider_type === 'azure_openai'" x-cloak>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >API Version *</label
                                        >
                                        <input
                                            type="text"
                                            x-model="groupFormData.api_version"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="如: 2024-02-15-preview"
                                        />
                                        <p class="text-xs text-gray-500 mt-1">
                                            Azure OpenAI API 版本
                                        </p>
                                    </div>

                                    <div class="md:col-span-2">
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >启用状态</label
                                        >
                                        <label
                                            class="flex items-center space-x-2 cursor-pointer"
                                        >
                                            <input
                                                type="checkbox"
                                                x-model="groupFormData.enabled"
                                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                            />
                                            <span class="text-sm text-gray-700"
                                                >启用此分组</span
                                            >
                                        </label>
                                        <p class="text-xs text-gray-500 mt-1">
                                            禁用后该分组将不会处理请求
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- 配置参数区域 -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <div class="flex items-center space-x-2 mb-6">
                                    <svg
                                        class="w-5 h-5 text-purple-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"
                                        ></path>
                                    </svg>
                                    <h4
                                        class="text-lg font-semibold text-gray-900"
                                    >
                                        配置参数
                                    </h4>
                                </div>
                                <!-- 基础配置 -->
                                <div class="mb-6">
                                    <h5
                                        class="text-sm font-medium text-gray-800 mb-4 flex items-center"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2 text-blue-500"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                                            ></path>
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                            ></path>
                                        </svg>
                                        基础配置
                                    </h5>
                                    <div
                                        class="grid grid-cols-1 md:grid-cols-3 gap-4"
                                    >
                                        <div
                                            class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"
                                        >
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2"
                                            >
                                                <svg
                                                    class="w-4 h-4 inline mr-1 text-orange-500"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                                    ></path>
                                                </svg>
                                                超时时间（秒）
                                            </label>
                                            <input
                                                type="number"
                                                x-model="groupFormData.timeout"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                min="1"
                                                max="600"
                                                placeholder="30"
                                            />
                                            <p
                                                class="text-xs text-gray-500 mt-2"
                                            >
                                                请求超时时间，建议30-120秒
                                            </p>
                                        </div>

                                        <div
                                            class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"
                                        >
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2"
                                            >
                                                <svg
                                                    class="w-4 h-4 inline mr-1 text-red-500"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                    ></path>
                                                </svg>
                                                最大重试次数
                                            </label>
                                            <input
                                                type="number"
                                                x-model="groupFormData.max_retries"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                min="0"
                                                max="10"
                                                placeholder="3"
                                            />
                                            <p
                                                class="text-xs text-gray-500 mt-2"
                                            >
                                                失败后的重试次数，建议1-5次
                                            </p>
                                        </div>

                                        <div
                                            class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"
                                        >
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2"
                                            >
                                                <svg
                                                    class="w-4 h-4 inline mr-1 text-green-500"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                                    ></path>
                                                </svg>
                                                轮换策略
                                            </label>
                                            <select
                                                x-model="groupFormData.rotation_strategy"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            >
                                                <option value="round_robin">
                                                    轮询 (Round Robin)
                                                </option>
                                                <option value="random">
                                                    随机 (Random)
                                                </option>
                                                <option value="least_used">
                                                    最少使用 (Least Used)
                                                </option>
                                            </select>
                                            <p
                                                class="text-xs text-gray-500 mt-2"
                                            >
                                                多个密钥时的选择策略
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- RPM限制配置 -->
                                <div class="mb-6">
                                    <h5
                                        class="text-sm font-medium text-gray-800 mb-4 flex items-center"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2 text-yellow-500"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"
                                            ></path>
                                        </svg>
                                        RPM限制
                                    </h5>
                                    <div
                                        class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"
                                    >
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >每分钟请求数限制</label
                                        >
                                        <input
                                            type="number"
                                            x-model="groupFormData.rpm_limit"
                                            min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="0"
                                        />
                                        <p class="text-xs text-gray-500 mt-2">
                                            每分钟请求数限制，0表示无限制
                                        </p>
                                    </div>
                                </div>

                                <!-- 高级选项 -->
                                <div>
                                    <h5
                                        class="text-sm font-medium text-gray-800 mb-4 flex items-center"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2 text-purple-500"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                                            ></path>
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                                            ></path>
                                        </svg>
                                        高级选项
                                    </h5>
                                    <div
                                        class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm"
                                    >
                                        <label
                                            class="flex items-start space-x-3 cursor-pointer"
                                        >
                                            <input
                                                type="checkbox"
                                                x-model="groupFormData.use_native_response"
                                                class="mt-1 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                                            />
                                            <div>
                                                <span
                                                    class="text-sm font-medium text-gray-700"
                                                    >使用原生接口响应</span
                                                >
                                                <p
                                                    class="text-xs text-gray-500 mt-1"
                                                >
                                                    勾选后将返回提供商的原生响应格式，而不是OpenAI兼容格式
                                                </p>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <!-- 密钥管理策略 -->
                                <div>
                                    <h5
                                        class="text-sm font-medium text-gray-800 mb-4 flex items-center"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2 text-orange-500"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                                            ></path>
                                        </svg>
                                        密钥管理策略
                                    </h5>
                                    <div
                                        class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm space-y-4"
                                    >
                                        <label
                                            class="flex items-start space-x-3 cursor-pointer"
                                        >
                                            <input
                                                type="checkbox"
                                                x-model="groupFormData.disable_permanent_ban"
                                                class="mt-1 rounded border-gray-300 text-orange-600 shadow-sm focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50"
                                            />
                                            <div>
                                                <span
                                                    class="text-sm font-medium text-gray-700"
                                                    >禁用永久禁用策略</span
                                                >
                                                <p
                                                    class="text-xs text-gray-500 mt-1"
                                                >
                                                    勾选后密钥达到错误上限不会被永久禁用，只会进入临时冷却期
                                                </p>
                                            </div>
                                        </label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-gray-700 mb-2"
                                                    >最大错误次数</label
                                                >
                                                <input
                                                    type="number"
                                                    x-model="groupFormData.max_error_count"
                                                    min="1"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                                    placeholder="10"
                                                />
                                                <p class="text-xs text-gray-500 mt-1">
                                                    密钥连续错误多少次后触发禁用（默认10次）
                                                </p>
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-gray-700 mb-2"
                                                    >限流冷却时间（秒）</label
                                                >
                                                <input
                                                    type="number"
                                                    x-model="groupFormData.rate_limit_cooldown"
                                                    min="0"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                                    placeholder="0"
                                                />
                                                <p class="text-xs text-gray-500 mt-1">
                                                    限流时的冷却时间，0表示使用渐进策略（1分钟→1小时）
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- API密钥区域 -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <div
                                    class="flex items-center justify-between mb-4"
                                >
                                    <div class="flex items-center space-x-2">
                                        <svg
                                            class="w-5 h-5 text-yellow-600"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2h4zm-6 2v6h4V9H9z"
                                            ></path>
                                        </svg>
                                        <h4
                                            class="text-lg font-semibold text-gray-900"
                                        >
                                            API密钥管理
                                        </h4>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <button
                                            type="button"
                                            @click="showBatchAddModal = true"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                                ></path>
                                            </svg>
                                            批量添加
                                        </button>
                                        <button
                                            type="button"
                                            @click="addGroupApiKey()"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                                ></path>
                                            </svg>
                                            添加密钥
                                        </button>
                                        <button
                                            type="button"
                                            @click="clearAllKeys()"
                                            :disabled="groupFormData.api_keys.filter(k => k.trim()).length === 0"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                ></path>
                                            </svg>
                                            清空密钥
                                        </button>
                                        <button
                                            type="button"
                                            @click="exportKeys()"
                                            :disabled="groupFormData.api_keys.filter(k => k.trim()).length === 0"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                ></path>
                                            </svg>
                                            导出密钥
                                        </button>
                                        <button
                                            type="button"
                                            @click="deleteInvalidKeys()"
                                            x-show="getInvalidKeyCount() > 0"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                ></path>
                                            </svg>
                                            删除失效密钥 (<span
                                                x-text="getInvalidKeyCount()"
                                            ></span
                                            >)
                                        </button>
                                        <button
                                            type="button"
                                            @click="bulkDeleteInvalidKeysFromServer()"
                                            x-show="showEditGroupModal && editingGroupId"
                                            :disabled="bulkDeletingInvalidKeys"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                        >
                                            <svg
                                                x-show="!bulkDeletingInvalidKeys"
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                ></path>
                                            </svg>
                                            <svg
                                                x-show="bulkDeletingInvalidKeys"
                                                class="animate-spin w-4 h-4 mr-1"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                            >
                                                <circle
                                                    class="opacity-25"
                                                    cx="12"
                                                    cy="12"
                                                    r="10"
                                                    stroke="currentColor"
                                                    stroke-width="4"
                                                ></circle>
                                                <path
                                                    class="opacity-75"
                                                    fill="currentColor"
                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                                ></path>
                                            </svg>
                                            <span x-show="!bulkDeletingInvalidKeys">一键删除失效密钥</span>
                                            <span x-show="bulkDeletingInvalidKeys">删除中...</span>
                                        </button>
                                        <button
                                            type="button"
                                            @click="deleteSelectedKeys()"
                                            x-show="selectedKeys.length > 0"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                ></path>
                                            </svg>
                                            删除选中 (<span
                                                x-text="selectedKeys.length"
                                            ></span
                                            >)
                                        </button>
                                        <button
                                            type="button"
                                            @click="removeDuplicateKeys()"
                                            x-show="checkCurrentKeyDuplicates().size > 0"
                                            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 transition-colors"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                                ></path>
                                            </svg>
                                            去除重复
                                        </button>
                                    </div>
                                </div>

                                <!-- 密钥列表 -->
                                <div
                                    class="border rounded-md max-h-60 overflow-y-auto"
                                >
                                    <div class="space-y-1 p-2">
                                        <template
                                            x-for="(key, index) in paginatedKeys"
                                            :key="index + keyPageOffset"
                                        >
                                            <div
                                                class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded"
                                                :class="getKeyValidationClass(index + keyPageOffset) + (checkCurrentKeyDuplicates().has(index + keyPageOffset) ? ' border-l-4 border-orange-400 bg-orange-50' : '')"
                                            >
                                                <input
                                                    type="checkbox"
                                                    :value="index + keyPageOffset"
                                                    x-model="selectedKeys"
                                                    class="rounded"
                                                />
                                                <div class="flex-1 relative">
                                                    <input
                                                        type="text"
                                                        x-model="groupFormData.api_keys[index + keyPageOffset]"
                                                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                        placeholder="输入API密钥"
                                                    />
                                                    <!-- 验证状态指示器 -->
                                                    <div
                                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center space-x-1"
                                                    >
                                                        <!-- 有效状态 -->
                                                        <div
                                                            x-show="keyValidationStatus[index + keyPageOffset] === 'valid'"
                                                            class="flex items-center"
                                                            title="密钥有效"
                                                        >
                                                            <svg
                                                                class="w-4 h-4 text-green-500"
                                                                fill="currentColor"
                                                                viewBox="0 0 20 20"
                                                            >
                                                                <path
                                                                    fill-rule="evenodd"
                                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                                    clip-rule="evenodd"
                                                                ></path>
                                                            </svg>
                                                        </div>
                                                        <!-- 无效状态 -->
                                                        <div
                                                            x-show="keyValidationStatus[index + keyPageOffset] === 'invalid'"
                                                            class="flex items-center"
                                                            title="密钥无效"
                                                        >
                                                            <svg
                                                                class="w-4 h-4 text-red-500"
                                                                fill="currentColor"
                                                                viewBox="0 0 20 20"
                                                            >
                                                                <path
                                                                    fill-rule="evenodd"
                                                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                                                    clip-rule="evenodd"
                                                                ></path>
                                                            </svg>
                                                        </div>
                                                        <!-- 未知状态（例如限速/临时错误） -->
                                                        <div
                                                            x-show="keyValidationStatus[index + keyPageOffset] === 'unknown'"
                                                            class="flex items-center"
                                                            title="状态未知（可能限速/临时错误）"
                                                        >
                                                            <svg
                                                                class="w-4 h-4 text-gray-500"
                                                                fill="currentColor"
                                                                viewBox="0 0 20 20"
                                                            >
                                                                <path
                                                                    fill-rule="evenodd"
                                                                    d="M18 10A8 8 0 11 2 10a8 8 0 0116 0zm-8-4a3 3 0 00-3 3 1 1 0 102 0 1 1 0 112 0c0 .513-.386.935-1.173 1.533C8.694 10.8 8 11.576 8 13a1 1 0 102 0c0-.68.22-.93 1.173-1.534C12.306 10.2 13 9.424 13 8a3 3 0 00-3-3zm0 10a1 1 0 100-2 1 1 0 000 2z"
                                                                    clip-rule="evenodd"
                                                                ></path>
                                                            </svg>
                                                        </div>
                                                        <!-- 验证中状态 -->
                                                        <div
                                                            x-show="keyValidationStatus[index + keyPageOffset] === 'validating'"
                                                            class="flex items-center"
                                                            title="验证中"
                                                        >
                                                            <svg
                                                                class="w-4 h-4 text-yellow-500 animate-spin"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                            >
                                                                <circle
                                                                    class="opacity-25"
                                                                    cx="12"
                                                                    cy="12"
                                                                    r="10"
                                                                    stroke="currentColor"
                                                                    stroke-width="4"
                                                                ></circle>
                                                                <path
                                                                    class="opacity-75"
                                                                    fill="currentColor"
                                                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                                                ></path>
                                                            </svg>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 强制设置密钥状态按钮 -->
                                                <div class="flex items-center space-x-1">
                                                    <button
                                                        type="button"
                                                        @click="forceSetKeyStatus(index + keyPageOffset, 'valid')"
                                                        :disabled="forcingKeyStatus[index + keyPageOffset]"
                                                        class="text-green-600 hover:text-green-800 p-1 rounded"
                                                        title="强制设为有效"
                                                        x-show="keyValidationStatus[index + keyPageOffset] !== 'valid'"
                                                    >
                                                        <svg
                                                            class="w-4 h-4"
                                                            fill="currentColor"
                                                            viewBox="0 0 20 20"
                                                        >
                                                            <path
                                                                fill-rule="evenodd"
                                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                                                clip-rule="evenodd"
                                                            ></path>
                                                        </svg>
                                                    </button>
                                                    <button
                                                        type="button"
                                                        @click="forceSetKeyStatus(index + keyPageOffset, 'invalid')"
                                                        :disabled="forcingKeyStatus[index + keyPageOffset]"
                                                        class="text-red-600 hover:text-red-800 p-1 rounded"
                                                        title="强制设为无效"
                                                        x-show="keyValidationStatus[index + keyPageOffset] !== 'invalid'"
                                                    >
                                                        <svg
                                                            class="w-4 h-4"
                                                            fill="currentColor"
                                                            viewBox="0 0 20 20"
                                                        >
                                                            <path
                                                                fill-rule="evenodd"
                                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                                                clip-rule="evenodd"
                                                            ></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <button
                                                    type="button"
                                                    @click="removeGroupApiKey(index + keyPageOffset)"
                                                    class="text-red-500 hover:text-red-700 p-1"
                                                >
                                                    <svg
                                                        class="w-4 h-4"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M6 18L18 6M6 6l12 12"
                                                        ></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- 分页控制 -->
                                    <div
                                        x-show="groupFormData.api_keys.length > keysPerPage"
                                        class="border-t p-2 flex justify-between items-center bg-gray-50"
                                    >
                                        <div class="text-sm text-gray-600">
                                            显示
                                            <span
                                                x-text="keyPageOffset + 1"
                                            ></span
                                            >-<span
                                                x-text="Math.min(keyPageOffset + keysPerPage, groupFormData.api_keys.length)"
                                            ></span>
                                            共
                                            <span
                                                x-text="groupFormData.api_keys.length"
                                            ></span>
                                            个密钥
                                        </div>
                                        <div class="flex space-x-1">
                                            <button
                                                type="button"
                                                @click="keyPage = Math.max(1, keyPage - 1)"
                                                :disabled="keyPage <= 1"
                                                class="px-2 py-1 text-sm border rounded disabled:opacity-50"
                                            >
                                                上一页
                                            </button>
                                            <button
                                                type="button"
                                                @click="keyPage = Math.min(totalKeyPages, keyPage + 1)"
                                                :disabled="keyPage >= totalKeyPages"
                                                class="px-2 py-1 text-sm border rounded disabled:opacity-50"
                                            >
                                                下一页
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 支持的模型 -->
                            <div class="md:col-span-2 mt-4">
                                <div
                                    class="flex justify-between items-center mb-2"
                                >
                                    <h4 class="font-semibold flex items-center space-x-2">
                                        <span>支持的模型（可选）</span>
                                        <span x-show="availableModels.length > 0"
                                              class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                                              x-text="availableModels.length + ' 个可用'">
                                        </span>
                                    </h4>
                                    <div class="flex space-x-2">
                                        <button
                                            type="button"
                                            @click="loadAvailableModels()"
                                            :disabled="!groupFormData.provider_type || !groupFormData.base_url || groupFormData.api_keys.filter(k => k.trim()).length === 0 || loadingModels"
                                            class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                            title="加载此提供商的可用模型列表。需要有效的API密钥和Base URL。"
                                        >
                                            <span x-show="!loadingModels"
                                                >加载模型</span
                                            >
                                            <span x-show="loadingModels"
                                                >加载中...</span
                                            >
                                        </button>
                                        <button
                                            type="button"
                                            @click="refreshModels()"
                                            :disabled="!groupFormData.provider_type || !groupFormData.base_url || groupFormData.api_keys.filter(k => k.trim()).length === 0 || refreshingModels"
                                            class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50"
                                            title="刷新模型列表（绕过缓存）"
                                        >
                                            <span x-show="!refreshingModels"
                                                >🔄 刷新</span
                                            >
                                            <span x-show="refreshingModels"
                                                >刷新中...</span
                                            >
                                        </button>
                                        <button
                                            type="button"
                                            @click="selectAllModels()"
                                            x-show="availableModels.length > 0"
                                            class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm"
                                        >
                                            全选
                                        </button>
                                        <button
                                            type="button"
                                            @click="clearAllModels()"
                                            x-show="groupFormData.models.length > 0"
                                            class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm"
                                        >
                                            清空
                                        </button>
                                    </div>
                                </div>

                                <!-- 模型选择器 -->
                                <div
                                    x-show="availableModels.length > 0"
                                    class="border rounded-md p-3 bg-gray-50 mb-3"
                                >
                                    <div
                                        class="flex justify-between items-center mb-2"
                                    >
                                        <div class="text-sm text-gray-600">
                                            从API加载的可用模型：
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            显示
                                            <span
                                                x-text="filteredModels.length"
                                            ></span>
                                            /
                                            <span
                                                x-text="availableModels.length"
                                            ></span>
                                            个模型
                                        </div>
                                    </div>

                                    <!-- 搜索框 -->
                                    <div class="mb-3">
                                        <div class="relative">
                                            <input
                                                type="text"
                                                x-model="modelSearchQuery"
                                                @input.debounce.300ms="filterModels()"
                                                placeholder="搜索模型名称、描述..."
                                                class="w-full px-3 py-2 pl-8 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            />
                                            <svg
                                                class="absolute left-2 top-2.5 h-4 w-4 text-gray-400"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                                ></path>
                                            </svg>
                                            <button
                                                x-show="modelSearchQuery"
                                                @click="clearModelSearch()"
                                                class="absolute right-2 top-2 text-gray-400 hover:text-gray-600"
                                            >
                                                <svg
                                                    class="h-4 w-4"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M6 18L18 6M6 6l12 12"
                                                    ></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- 过滤器芯片 -->
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <button
                                            type="button"
                                            @click="filterByCapability('all')"
                                            :class="modelCapabilityFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                                            class="px-2 py-1 rounded text-xs hover:opacity-80 transition"
                                        >
                                            全部 (<span x-text="availableModels.length"></span>)
                                        </button>
                                        <button
                                            type="button"
                                            @click="filterByCapability('vision')"
                                            :class="modelCapabilityFilter === 'vision' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700'"
                                            class="px-2 py-1 rounded text-xs hover:opacity-80 transition"
                                            title="筛选支持视觉的模型"
                                        >
                                            👁️ 视觉
                                        </button>
                                        <button
                                            type="button"
                                            @click="filterByCapability('function_calling')"
                                            :class="modelCapabilityFilter === 'function_calling' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'"
                                            class="px-2 py-1 rounded text-xs hover:opacity-80 transition"
                                            title="筛选支持函数调用的模型"
                                        >
                                            🔧 函数调用
                                        </button>
                                    </div>

                                    <!-- 模型列表 -->
                                    <div
                                        class="max-h-60 overflow-y-auto space-y-2"
                                    >
                                        <template
                                            x-for="model in filteredModels"
                                            :key="model.id"
                                        >
                                            <label
                                                class="flex items-start space-x-3 text-sm hover:bg-white p-2 rounded cursor-pointer border border-transparent hover:border-blue-200 transition-all"
                                            >
                                                <input
                                                    type="checkbox"
                                                    :value="model.id"
                                                    x-model="groupFormData.models"
                                                    class="mt-1 rounded text-blue-600 focus:ring-blue-500"
                                                />
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="font-mono font-semibold text-gray-900" x-text="model.id"></span>
                                                        <span x-show="model.capabilities && model.capabilities.includes('vision')"
                                                              class="text-xs bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded"
                                                              title="支持视觉">👁️</span>
                                                        <span x-show="model.capabilities && model.capabilities.includes('function_calling')"
                                                              class="text-xs bg-green-100 text-green-700 px-1.5 py-0.5 rounded"
                                                              title="支持函数调用">🔧</span>
                                                    </div>
                                                    <div class="flex items-center space-x-2 mt-1 text-xs text-gray-500">
                                                        <span x-show="model.owned_by" x-text="model.owned_by"></span>
                                                        <span x-show="model.context_window" class="text-gray-400">
                                                            • <span x-text="formatContextWindow(model.context_window)"></span>
                                                        </span>
                                                    </div>
                                                    <div x-show="model.display_name && model.display_name !== model.id"
                                                         class="text-xs text-gray-600 mt-0.5"
                                                         x-text="model.display_name"></div>
                                                </div>
                                            </label>
                                        </template>
                                        <div
                                            x-show="filteredModels.length === 0 && modelSearchQuery"
                                            class="text-center py-8 text-gray-500 text-sm"
                                        >
                                            <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p>未找到匹配的模型</p>
                                            <p class="text-xs mt-1">尝试调整搜索关键词</p>
                                        </div>
                                    </div>

                                    <!-- 加载状态骨架屏 -->
                                    <div x-show="loadingModels" class="space-y-2 animate-pulse">
                                        <div class="h-10 bg-gray-200 rounded"></div>
                                        <div class="h-10 bg-gray-200 rounded"></div>
                                        <div class="h-10 bg-gray-200 rounded"></div>
                                        <div class="h-10 bg-gray-200 rounded"></div>
                                    </div>

                                    <!-- 错误状态 -->
                                    <div x-show="modelLoadError" class="bg-red-50 border border-red-200 rounded-lg p-4 mt-3">
                                        <div class="flex items-start space-x-3">
                                            <svg class="w-5 h-5 text-red-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <div class="flex-1">
                                                <h4 class="text-sm font-semibold text-red-800">加载模型失败</h4>
                                                <p class="text-sm text-red-700 mt-1" x-text="modelLoadError"></p>
                                                <button
                                                    type="button"
                                                    @click="loadAvailableModels(true)"
                                                    class="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                                                >
                                                    重试
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 空状态 -->
                                    <div x-show="availableModels.length === 0 && !loadingModels && !modelLoadError"
                                         class="text-center py-8 text-gray-500">
                                        <svg class="w-16 h-16 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                        </svg>
                                        <p class="text-sm font-medium">暂无可用模型</p>
                                        <p class="text-xs mt-1">点击"加载模型"按钮获取模型列表</p>
                                    </div>
                                </div>

                                <!-- 手动输入模型 -->
                                <div>
                                    <div class="text-sm text-gray-600 mb-2">
                                        或手动输入模型名称：
                                    </div>
                                    <textarea
                                        x-model="modelsText"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="3"
                                        placeholder="每行一个模型名称，留空表示支持所有模型"
                                    ></textarea>
                                    <p class="text-sm text-gray-500 mt-1">
                                        每行输入一个模型名称，如：gpt-3.5-turbo
                                    </p>
                                </div>

                                <!-- 已选择的模型预览 -->
                                <div
                                    x-show="groupFormData.models.length > 0"
                                    class="mt-4 bg-blue-50 rounded-lg p-4 border border-blue-200"
                                >
                                    <div class="flex justify-between items-center mb-3">
                                        <div class="text-sm font-semibold text-blue-900">
                                            已选择 <span x-text="groupFormData.models.length" class="text-lg"></span> 个模型
                                        </div>
                                        <button
                                            type="button"
                                            @click="sortSelectedModels()"
                                            class="text-xs text-blue-600 hover:text-blue-800 underline"
                                        >
                                            按名称排序
                                        </button>
                                    </div>
                                    <div class="flex flex-wrap gap-2 max-h-40 overflow-y-auto">
                                        <template
                                            x-for="model in groupFormData.models"
                                            :key="model"
                                        >
                                            <span
                                                class="inline-flex items-center px-3 py-1.5 rounded-full text-sm bg-blue-100 text-blue-800 border border-blue-300 hover:bg-blue-200 transition-colors"
                                            >
                                                <span x-text="model" class="font-mono"></span>
                                                <button
                                                    type="button"
                                                    @click="removeModel(model)"
                                                    class="ml-2 text-blue-600 hover:text-blue-900 focus:outline-none"
                                                    title="移除此模型"
                                                >
                                                    <svg
                                                        class="w-4 h-4"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            stroke-linecap="round"
                                                            stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M6 18L18 6M6 6l12 12"
                                                        ></path>
                                                    </svg>
                                                </button>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- HTTP Headers配置 -->
                            <div class="md:col-span-2 mt-4">
                                <div
                                    class="flex justify-between items-center mb-2"
                                >
                                    <h4 class="font-semibold">
                                        HTTP Headers覆盖（可选）
                                    </h4>
                                    <button
                                        type="button"
                                        @click="showHeadersHelp = !showHeadersHelp"
                                        class="text-gray-400 hover:text-gray-600"
                                    >
                                        <svg
                                            class="w-4 h-4"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- 帮助信息 -->
                                <div
                                    x-show="showHeadersHelp"
                                    x-collapse
                                    class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700"
                                >
                                    <p class="mb-2">
                                        <strong>HTTP Headers覆盖功能说明：</strong>
                                    </p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>
                                            可以为该分组设置默认的HTTP headers，这些headers会覆盖请求中的对应headers
                                        </li>
                                        <li>
                                            常用于：Authorization（认证）、X-Custom-Header（自定义头）、anthropic-version（Anthropic版本）等
                                        </li>
                                        <li>
                                            支持两种方式：<strong>逐个添加</strong>和<strong>JSON批量导入</strong>
                                        </li>
                                        <li>
                                            JSON格式示例：{"Authorization": "Bearer sk-xxx", "X-Custom-Header": "value"}
                                        </li>
                                        <li>
                                            留空表示不覆盖任何headers，使用请求中的原始headers
                                        </li>
                                    </ul>
                                </div>

                                <!-- JSON批量导入区域 -->
                                <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-md">
                                    <div class="flex items-center justify-between mb-2">
                                        <h5 class="font-semibold text-gray-700">JSON批量导入</h5>
                                        <div class="flex space-x-2">
                                            <button
                                                type="button"
                                                @click="parseHeadersJson()"
                                                :disabled="!headersJsonText.trim() || headersJsonValidationError"
                                                class="px-3 py-1 text-sm bg-green-500 hover:bg-green-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                导入Headers
                                            </button>
                                            <button
                                                type="button"
                                                @click="clearAllHeaders()"
                                                :disabled="headers.length === 0"
                                                class="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                清空所有
                                            </button>
                                        </div>
                                    </div>
                                    <textarea
                                        x-model="headersJsonText"
                                        @input="validateHeadersJson()"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                        rows="4"
                                        placeholder='{"Authorization": "Bearer sk-xxx", "X-Custom-Header": "value"}'
                                    ></textarea>
                                    <p class="text-sm text-gray-500 mt-1">
                                        输入JSON格式的headers，支持批量添加和覆盖
                                    </p>
                                    <!-- JSON验证状态 -->
                                    <div
                                        x-show="headersJsonValidationMessage"
                                        class="mt-2"
                                    >
                                        <div
                                            :class="headersJsonValidationError ? 'text-red-600' : 'text-green-600'"
                                            class="text-sm flex items-center"
                                        >
                                            <svg
                                                class="w-4 h-4 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                            >
                                                <path
                                                    x-show="headersJsonValidationError"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                                ></path>
                                                <path
                                                    x-show="!headersJsonValidationError"
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                                ></path>
                                            </svg>
                                            <span
                                                x-text="headersJsonValidationMessage"
                                            ></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Headers列表 -->
                                <div class="space-y-2">
                                    <template
                                        x-for="(header, index) in headers"
                                        :key="index"
                                    >
                                        <div
                                            class="flex items-center space-x-2 p-2 border border-gray-200 rounded-md"
                                        >
                                            <div class="flex-1">
                                                <label
                                                    class="block text-xs text-gray-500 mb-1"
                                                    >Header Key</label
                                                >
                                                <input
                                                    type="text"
                                                    x-model="header.key"
                                                    placeholder="例如: Authorization"
                                                    @input="syncHeadersToGroupForm()"
                                                />
                                            </div>
                                            <div class="text-gray-400">:</div>
                                            <div class="flex-1">
                                                <label
                                                    class="block text-xs text-gray-500 mb-1"
                                                    >Header Value</label
                                                >
                                                <input
                                                    type="text"
                                                    x-model="header.value"
                                                    placeholder="例如: Bearer sk-xxx"
                                                    @input="syncHeadersToGroupForm()"
                                                />
                                            </div>
                                            <button
                                                type="button"
                                                @click="removeHeader(index)"
                                                class="text-red-500 hover:text-red-700 p-1"
                                            >
                                                <svg
                                                    class="w-4 h-4"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                    ></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>

                                    <!-- 添加新Header按钮 -->
                                    <button
                                        type="button"
                                        @click="addHeader()"
                                        class="w-full py-2 px-4 border-2 border-dashed border-gray-300 rounded-md text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <svg
                                            class="w-4 h-4 inline mr-2"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 4v16m8-8H4"
                                            ></path>
                                        </svg>
                                        添加Header
                                    </button>
                                </div>
                            </div>

                            <!-- 模型重命名配置 -->
                            <div class="md:col-span-2 mt-4">
                                <div
                                    class="flex justify-between items-center mb-2"
                                >
                                    <h4 class="font-semibold">
                                        模型重命名配置（可选）
                                    </h4>
                                    <button
                                        type="button"
                                        @click="showModelMappingHelp = !showModelMappingHelp"
                                        class="text-gray-400 hover:text-gray-600"
                                    >
                                        <svg
                                            class="w-4 h-4"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- 帮助信息 -->
                                <div
                                    x-show="showModelMappingHelp"
                                    x-collapse
                                    class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700"
                                >
                                    <p class="mb-2">
                                        <strong>模型重命名功能说明：</strong>
                                    </p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>
                                            可以为该分组的模型设置别名，统一不同分组的模型名称
                                        </li>
                                        <li>
                                            客户端使用别名请求时，系统会自动转换为实际的模型名称
                                        </li>
                                        <li>
                                            例如：将"gpt-4-turbo"重命名为"gpt-4"，客户端可以统一使用"gpt-4"
                                        </li>
                                        <li>
                                            支持多个别名映射到同一个实际模型
                                        </li>
                                        <li class="text-blue-600">
                                            <strong>跨分组映射：</strong>不同分组可以使用相同的别名，系统会自动选择可用的分组
                                        </li>
                                        <li class="text-orange-600">
                                            <strong>同分组限制：</strong>同一分组内，一个别名只能映射到一个模型
                                        </li>
                                    </ul>
                                </div>

                                <!-- 模型映射列表 -->
                                <div class="space-y-2">
                                    <template
                                        x-for="(mapping, index) in modelMappings"
                                        :key="index"
                                    >
                                        <div
                                            class="flex items-center space-x-2 p-2 border border-gray-200 rounded-md"
                                        >
                                            <div class="flex-1">
                                                <label
                                                    class="block text-xs text-gray-500 mb-1"
                                                    >别名（客户端使用）</label
                                                >
                                                <input
                                                    type="text"
                                                    x-model="mapping.alias"
                                                    :class="getDuplicateAliasClass(mapping.alias, index)"
                                                    placeholder="例如: gpt-4"
                                                />
                                                <div
                                                    x-show="isDuplicateAlias(mapping.alias, index)"
                                                    class="text-xs text-orange-600 mt-1"
                                                >
                                                    ⚠️ 此别名在当前分组中已存在
                                                </div>
                                            </div>
                                            <div class="text-gray-400">→</div>
                                            <div class="flex-1">
                                                <label
                                                    class="block text-xs text-gray-500 mb-1"
                                                    >实际模型名称</label
                                                >
                                                <select
                                                    x-model="mapping.original"
                                                    class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                >
                                                    <option value="">
                                                        请选择模型
                                                    </option>
                                                    <template
                                                        x-for="model in groupFormData.models"
                                                        :key="model"
                                                    >
                                                        <option
                                                            :value="model"
                                                            :selected="model === mapping.original"
                                                            x-text="model"
                                                        ></option>
                                                    </template>
                                                </select>
                                            </div>
                                            <button
                                                type="button"
                                                @click="removeModelMapping(index)"
                                                class="text-red-500 hover:text-red-700 p-1"
                                            >
                                                <svg
                                                    class="w-4 h-4"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                                    ></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>

                                    <!-- 添加新映射按钮 -->
                                    <button
                                        type="button"
                                        @click="addModelMapping()"
                                        class="w-full py-2 px-4 border-2 border-dashed border-gray-300 rounded-md text-gray-500 hover:border-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <svg
                                            class="w-4 h-4 inline mr-2"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 4v16m8-8H4"
                                            ></path>
                                        </svg>
                                        添加模型重命名
                                    </button>
                                </div>
                            </div>

                            <!-- JSON请求参数覆盖 -->
                            <div class="md:col-span-2 mt-4">
                                <div
                                    class="flex justify-between items-center mb-2"
                                >
                                    <h4 class="font-semibold">
                                        JSON请求参数覆盖（可选）
                                    </h4>
                                    <button
                                        type="button"
                                        @click="showRequestParamsHelp = !showRequestParamsHelp"
                                        class="text-gray-400 hover:text-gray-600"
                                    >
                                        <svg
                                            class="w-4 h-4"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- 帮助信息 -->
                                <div
                                    x-show="showRequestParamsHelp"
                                    x-collapse
                                    class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-700"
                                >
                                    <p class="mb-2">
                                        <strong
                                            >JSON请求参数覆盖功能说明：</strong
                                        >
                                    </p>
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>
                                            可以为该分组设置默认的请求参数，这些参数会覆盖客户端发送的参数
                                        </li>
                                        <li>
                                            支持任意JSON参数，包括但不限于：temperature（温度）、max_tokens（最大token数）、top_p、top_k、stop（停止词）、stream（流式输出）、presence_penalty、frequency_penalty 等
                                        </li>
                                        <li>
                                            示例：{"temperature": 0.7, "max_tokens": 1000, "top_p": 0.9, "stream": true}
                                        </li>
                                        <li>
                                            支持嵌套对象和数组，例如：{"stop": ["Human:", "AI:"], "response_format": {"type": "json_object"}}
                                        </li>
                                        <li>
                                            留空表示不覆盖任何参数，使用客户端发送的原始参数
                                        </li>
                                    </ul>
                                </div>

                                <!-- JSON编辑器 -->
                                <div>
                                    <textarea
                                        x-model="requestParamsText"
                                        @input="validateRequestParams()"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                        rows="6"
                                        placeholder='{"temperature": 0.7, "max_tokens": 1000, "top_p": 0.9, "stream": true, "stop": ["Human:", "AI:"]}'
                                    ></textarea>
                                    <p class="text-sm text-gray-500 mt-1">
                                        请输入有效的JSON格式，支持任意参数。留空表示不覆盖任何参数
                                    </p>
                                </div>

                                <!-- JSON验证状态 -->
                                <div
                                    x-show="requestParamsValidationMessage"
                                    class="mt-2"
                                >
                                    <div
                                        :class="requestParamsValidationError ? 'text-red-600' : 'text-green-600'"
                                        class="text-sm flex items-center"
                                    >
                                        <svg
                                            class="w-4 h-4 mr-1"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                x-show="requestParamsValidationError"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                            <path
                                                x-show="!requestParamsValidationError"
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                            ></path>
                                        </svg>
                                        <span
                                            x-text="requestParamsValidationMessage"
                                        ></span>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- 底部操作 -->
                    <div
                        class="border-t border-gray-200 px-6 py-4 bg-gray-50 rounded-b-lg"
                    >
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                <span x-show="showCreateGroupModal"
                                    >填写完整信息后点击创建</span
                                >
                                <span x-show="showEditGroupModal"
                                    >修改完成后点击更新保存</span
                                >
                            </div>
                            <div class="flex space-x-3">
                                <button
                                    type="button"
                                    @click="closeGroupModal()"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
                                >
                                    取消
                                </button>
                                <button
                                    type="submit"
                                    form="groupForm"
                                    :disabled="submittingGroup"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                                >
                                    <svg
                                        x-show="submittingGroup"
                                        class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                    >
                                        <circle
                                            class="opacity-25"
                                            cx="12"
                                            cy="12"
                                            r="10"
                                            stroke="currentColor"
                                            stroke-width="4"
                                        ></circle>
                                        <path
                                            class="opacity-75"
                                            fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                        ></path>
                                    </svg>
                                    <span
                                        x-show="!submittingGroup"
                                        x-text="showCreateGroupModal ? '创建分组' : '更新分组'"
                                    ></span>
                                    <span x-show="submittingGroup"
                                        >处理中...</span
                                    >
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batch Add Keys Modal -->
            <div
                x-show="showBatchAddModal"
                x-cloak
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
                @click.self="showBatchAddModal = false"
            >
                <div class="bg-white rounded-lg p-6 w-full max-w-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">批量添加API密钥</h3>
                        <button
                            @click="showBatchAddModal = false"
                            class="text-gray-500 hover:text-gray-700"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                ></path>
                            </svg>
                        </button>
                    </div>

                    <div class="mb-4">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-2"
                            >API密钥列表</label
                        >
                        <textarea
                            x-model="batchKeysText"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="8"
                            placeholder="每行输入一个API密钥&#10;支持以下格式：&#10;sk-1234567890abcdef&#10;your-api-key-here&#10;&#10;空行将被忽略"
                        ></textarea>
                        <p class="text-sm text-gray-500 mt-1">
                            每行输入一个API密钥，空行将被自动忽略
                        </p>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button
                            type="button"
                            @click="showBatchAddModal = false"
                            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50"
                        >
                            取消
                        </button>
                        <button
                            type="button"
                            @click="addBatchKeys()"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md"
                        >
                            添加密钥
                        </button>
                    </div>
                </div>
            </div>

            <!-- Import Groups Modal -->
            <div
                x-show="showImportModal"
                x-cloak
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                @click.self="showImportModal = false"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
            >
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">
                            导入分组配置
                        </h3>
                    </div>

                    <div class="px-6 py-4">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                选择配置文件 (YAML格式)
                            </label>
                            <input
                                type="file"
                                accept=".yaml,.yml"
                                @change="handleFileSelect"
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                            />
                        </div>

                        <div class="text-sm text-gray-600">
                            <p class="mb-2">注意事项：</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>仅支持YAML格式的配置文件</li>
                                <li>导入的分组将覆盖同名的现有分组</li>
                                <li>请确保配置文件格式正确</li>
                            </ul>
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                        <button
                            @click="showImportModal = false"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition duration-200"
                        >
                            取消
                        </button>
                        <button
                            @click="importGroups()"
                            :disabled="!selectedFile || importing"
                            class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed rounded-md transition duration-200"
                        >
                            <span x-show="!importing">导入</span>
                            <span x-show="importing">导入中...</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Proxy Key Management Modal -->
            <div
                x-show="showProxyKeyModal"
                x-cloak
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                @click.self="showProxyKeyModal = false"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
            >
                <div
                    class="bg-white rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col"
                >
                    <!-- 头部 -->
                    <div
                        class="flex justify-between items-center p-6 border-b border-gray-200"
                    >
                        <div class="flex items-center space-x-3">
                            <div
                                class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center"
                            >
                                <svg
                                    class="w-4 h-4 text-indigo-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2"
                                    ></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">
                                    代理服务 API 密钥
                                </h3>
                                <p class="text-sm text-gray-500">
                                    管理用于访问代理服务的API密钥
                                </p>
                            </div>
                        </div>
                        <button
                            @click="showProxyKeyModal = false"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                        >
                            <svg
                                class="w-6 h-6"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                ></path>
                            </svg>
                        </button>
                    </div>

                    <!-- 内容 -->
                    <div class="flex-1 overflow-y-auto p-6">
                        <!-- 操作栏 -->
                        <div
                            class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                        >
                            <!-- 生成新密钥按钮 -->
                            <button
                                @click="showGenerateProxyKeyForm = true"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-200"
                            >
                                <svg
                                    class="w-4 h-4 inline mr-2"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 4v16m8-8H4"
                                    ></path>
                                </svg>
                                生成新密钥
                            </button>

                            <!-- 手动刷新按钮 - 图标样式 -->
                            <button
                                @click="refreshProxyKeysOnly()"
                                class="bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 p-2 rounded-lg transition duration-200"
                                title="手动刷新使用次数"
                            >
                                <svg
                                    class="w-5 h-5"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                    ></path>
                                </svg>
                            </button>

                            <!-- 搜索框、排序和页面大小选择 -->
                            <div class="flex flex-col sm:flex-row gap-2">
                                <!-- 搜索框 -->
                                <div class="relative">
                                    <input
                                        type="text"
                                        x-model="proxyKeySearch"
                                        @input="searchProxyKeys()"
                                        @keyup.enter="searchProxyKeys()"
                                        placeholder="搜索密钥名称、描述或密钥..."
                                        class="w-full sm:w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                                    >
                                        <svg
                                            class="h-5 w-5 text-gray-400"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                                            ></path>
                                        </svg>
                                    </div>
                                    <button
                                        x-show="proxyKeySearch"
                                        @click="clearProxyKeySearch()"
                                        class="absolute inset-y-0 right-0 pr-3 flex items-center"
                                    >
                                        <svg
                                            class="h-4 w-4 text-gray-400 hover:text-gray-600"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12"
                                            ></path>
                                        </svg>
                                    </button>
                                </div>

                                <!-- 排序选择 -->
                                <select
                                    x-model="proxyKeySortBy"
                                    @change="changeProxyKeySortBy()"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    <option value="created_time_desc">创建时间 ↓</option>
                                    <option value="created_time_asc">创建时间 ↑</option>
                                    <option value="usage_count_desc">使用次数 ↓</option>
                                    <option value="usage_count_asc">使用次数 ↑</option>
                                    <option value="name_asc">名称 A-Z</option>
                                    <option value="name_desc">名称 Z-A</option>
                                </select>

                                <!-- 页面大小选择 -->
                                <select
                                    x-model="proxyKeyPageSize"
                                    @change="changeProxyKeyPageSize()"
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    <option value="5">5条/页</option>
                                    <option value="10">10条/页</option>
                                    <option value="20">20条/页</option>
                                    <option value="50">50条/页</option>
                                </select>
                            </div>
                        </div>

                        <!-- 生成密钥表单 -->
                        <div
                            x-show="showGenerateProxyKeyForm"
                            x-cloak
                            class="mb-6 p-6 bg-gray-50 rounded-lg border border-gray-200"
                        >
                            <h4
                                class="text-lg font-medium mb-6 flex items-center"
                            >
                                <svg
                                    class="w-5 h-5 mr-2 text-indigo-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2h4zm-6 2v6h4V9H9z"
                                    ></path>
                                </svg>
                                生成新的代理密钥
                            </h4>

                            <!-- 基本信息 -->
                            <div class="mb-6">
                                <h5
                                    class="text-sm font-medium text-gray-800 mb-3"
                                >
                                    基本信息
                                </h5>
                                <div
                                    class="grid grid-cols-1 md:grid-cols-2 gap-4"
                                >
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >密钥名称 *</label
                                        >
                                        <input
                                            type="text"
                                            x-model="newProxyKey.name"
                                            required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="输入密钥名称"
                                        />
                                    </div>
                                    <div>
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >描述</label
                                        >
                                        <input
                                            type="text"
                                            x-model="newProxyKey.description"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="输入描述信息"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- 分组权限 -->
                            <div class="mb-6">
                                <h5
                                    class="text-sm font-medium text-gray-800 mb-3"
                                >
                                    分组权限
                                </h5>
                                <div
                                    class="bg-white rounded-lg border border-gray-200 p-4"
                                >
                                    <label
                                        class="block text-sm font-medium text-gray-700 mb-3"
                                        >允许访问的分组</label
                                    >
                                    <div
                                        class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto"
                                    >
                                        <template
                                            x-for="(provider, groupId) in providerStatuses"
                                            :key="groupId"
                                        >
                                            <label
                                                class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded"
                                            >
                                                <input
                                                    type="checkbox"
                                                    :value="groupId"
                                                    :checked="newProxyKey.allowedGroups.includes(groupId)"
                                                    @change="toggleProxyKeyGroup(groupId, $event.target.checked)"
                                                    class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                />
                                                <span
                                                    class="text-sm"
                                                    x-text="provider.group_name"
                                                ></span>
                                            </label>
                                        </template>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        不选择任何分组表示可以访问所有分组
                                    </p>
                                </div>
                            </div>

                            <!-- 分组间请求设置 -->
                            <div
                                x-show="newProxyKey.allowedGroups.length > 1 || newProxyKey.allowedGroups.length === 0"
                                class="mb-6"
                            >
                                <h5
                                    class="text-sm font-medium text-gray-800 mb-3 flex items-center"
                                >
                                    <svg
                                        class="w-4 h-4 mr-2 text-blue-500"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M8 9l3 3-3 3m5 0h3"
                                        ></path>
                                    </svg>
                                    分组间请求设置
                                </h5>
                                <div
                                    class="bg-white rounded-lg border border-gray-200 p-4"
                                >
                                    <div class="mb-4">
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-2"
                                            >选择策略</label
                                        >
                                        <select
                                            x-model="newProxyKey.groupSelectionConfig.strategy"
                                            @change="onNewProxyKeyStrategyChange()"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        >
                                            <option value="round_robin">
                                                轮询 (Round Robin) -
                                                在分组间轮流分配请求
                                            </option>
                                            <option value="weighted">
                                                权重 (Weighted) -
                                                根据权重比例分配请求
                                            </option>
                                            <option value="random">
                                                随机 (Random) - 随机选择分组
                                            </option>
                                            <option value="failover">
                                                故障转移 (Failover) -
                                                按优先级顺序选择
                                            </option>
                                        </select>
                                    </div>

                                    <!-- 权重配置 -->
                                    <div
                                        x-show="newProxyKey.groupSelectionConfig.strategy === 'weighted'"
                                        class="mt-4"
                                    >
                                        <label
                                            class="block text-sm font-medium text-gray-700 mb-3"
                                            >分组权重配置</label
                                        >
                                        <div class="space-y-2">
                                            <template
                                                x-for="groupId in getGroupsForWeightConfig(newProxyKey.allowedGroups)"
                                                :key="groupId"
                                            >
                                                <div
                                                    class="flex items-center space-x-3 p-2 bg-gray-50 rounded"
                                                >
                                                    <span
                                                        class="text-sm font-medium min-w-0 flex-1"
                                                        x-text="getGroupName(groupId)"
                                                    ></span>
                                                    <div
                                                        class="flex items-center space-x-2"
                                                    >
                                                        <label
                                                            class="text-xs text-gray-600"
                                                            >权重:</label
                                                        >
                                                        <input
                                                            type="number"
                                                            :value="getGroupWeight(groupId)"
                                                            @input="setGroupWeight(groupId, $event.target.value)"
                                                            min="1"
                                                            max="100"
                                                            class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                                        />
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">
                                            权重越高，获得的请求越多。例如权重3:1的分组将获得约75%:25%的请求分配。
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-2">
                                <button
                                    @click="generateProxyKey()"
                                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md flex items-center"
                                >
                                    <svg
                                        class="w-4 h-4 mr-2"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M12 4v16m8-8H4"
                                        ></path>
                                    </svg>
                                    生成密钥
                                </button>
                                <button
                                    @click="showGenerateProxyKeyForm = false; resetProxyKeyForm()"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md"
                                >
                                    取消
                                </button>
                            </div>
                        </div>

                        <!-- 密钥列表 -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            密钥
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            名称/描述
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            分组配置
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            请求次数
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            创建时间
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                        >
                                            操作
                                        </th>
                                    </tr>
                                </thead>
                                <tbody
                                    class="bg-white divide-y divide-gray-200"
                                >
                                    <template
                                        x-for="key in proxyKeys"
                                        :key="key.id"
                                    >
                                        <tr>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap"
                                            >
                                                <div class="flex items-center">
                                                    <code
                                                        class="text-sm font-mono bg-gray-100 px-2 py-1 rounded"
                                                        x-text="key.key.substring(0, 20) + '...'"
                                                    ></code>
                                                    <button
                                                        @click="copyToClipboard(key.key)"
                                                        class="ml-2 text-gray-400 hover:text-gray-600"
                                                    >
                                                        <svg
                                                            class="w-4 h-4"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            viewBox="0 0 24 24"
                                                        >
                                                            <path
                                                                stroke-linecap="round"
                                                                stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                                                            ></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div class="mt-1">
                                                    <template
                                                        x-if="key.allowed_groups && key.allowed_groups.length > 0"
                                                    >
                                                        <div
                                                            class="flex flex-wrap gap-1"
                                                        >
                                                            <template
                                                                x-for="groupId in key.allowed_groups"
                                                                :key="groupId"
                                                            >
                                                                <span
                                                                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                                                    x-text="getGroupName(groupId)"
                                                                ></span>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template
                                                        x-if="!key.allowed_groups || key.allowed_groups.length === 0"
                                                    >
                                                        <span
                                                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800"
                                                            >所有分组</span
                                                        >
                                                    </template>
                                                </div>
                                            </td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap"
                                            >
                                                <div
                                                    class="text-sm font-medium text-gray-900"
                                                    x-text="key.name"
                                                ></div>
                                                <div
                                                    class="text-sm text-gray-500"
                                                    x-text="key.description"
                                                ></div>
                                            </td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap"
                                            >
                                                <!-- 分组选择配置显示 -->
                                                <template
                                                    x-if="key.allowed_groups && key.allowed_groups.length > 1"
                                                >
                                                    <div class="text-sm">
                                                        <div
                                                            class="flex items-center space-x-2 mb-1"
                                                        >
                                                            <span
                                                                class="text-xs font-medium text-gray-600"
                                                                >策略:</span
                                                            >
                                                            <span
                                                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                                :class="getStrategyBadgeClass(key.group_selection_config?.strategy || 'round_robin')"
                                                                x-text="getStrategyDisplayName(key.group_selection_config?.strategy || 'round_robin')"
                                                            ></span>
                                                        </div>
                                                        <template
                                                            x-if="key.group_selection_config?.strategy === 'weighted' && key.group_selection_config?.group_weights"
                                                        >
                                                            <div
                                                                class="text-xs text-gray-500"
                                                            >
                                                                <template
                                                                    x-for="weight in key.group_selection_config.group_weights"
                                                                    :key="weight.group_id"
                                                                >
                                                                    <div
                                                                        class="flex justify-between"
                                                                    >
                                                                        <span
                                                                            x-text="getGroupName(weight.group_id)"
                                                                        ></span>
                                                                        <span
                                                                            x-text="'权重: ' + weight.weight"
                                                                        ></span>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                                <template
                                                    x-if="!key.allowed_groups || key.allowed_groups.length <= 1"
                                                >
                                                    <span
                                                        class="text-xs text-gray-400"
                                                        >单分组</span
                                                    >
                                                </template>
                                            </td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                                x-text="key.usage_count || 0"
                                            ></td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                x-text="formatDate(key.created_at)"
                                            ></td>
                                            <td
                                                class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                                            >
                                                <button
                                                    @click="editProxyKey(key)"
                                                    class="text-indigo-600 hover:text-indigo-900 mr-3"
                                                >
                                                    编辑
                                                </button>
                                                <button
                                                    @click="deleteProxyKey(key.id)"
                                                    class="text-red-600 hover:text-red-900"
                                                >
                                                    删除
                                                </button>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-if="proxyKeys.length === 0">
                                        <tr>
                                            <td
                                                colspan="6"
                                                class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center"
                                            >
                                                <template
                                                    x-if="proxyKeySearch.trim()"
                                                >
                                                    <span
                                                        >未找到匹配的代理密钥</span
                                                    >
                                                </template>
                                                <template
                                                    x-if="!proxyKeySearch.trim()"
                                                >
                                                    <span>暂无代理密钥</span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页控件 -->
                        <div
                            x-show="proxyKeyPagination.total > 0"
                            class="mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                        >
                            <!-- 分页信息 -->
                            <div class="text-sm text-gray-700">
                                显示第
                                <span
                                    class="font-medium"
                                    x-text="((proxyKeyPagination.page - 1) * proxyKeyPagination.page_size + 1)"
                                ></span>
                                到
                                <span
                                    class="font-medium"
                                    x-text="Math.min(proxyKeyPagination.page * proxyKeyPagination.page_size, proxyKeyPagination.total)"
                                ></span>
                                条，共
                                <span
                                    class="font-medium"
                                    x-text="proxyKeyPagination.total"
                                ></span>
                                条记录
                            </div>

                            <!-- 分页按钮 -->
                            <div class="flex items-center space-x-2">
                                <!-- 上一页 -->
                                <button
                                    @click="goToProxyKeyPage(proxyKeyPagination.page - 1)"
                                    :disabled="!proxyKeyPagination.has_prev"
                                    :class="proxyKeyPagination.has_prev ? 'text-gray-500 hover:text-gray-700' : 'text-gray-300 cursor-not-allowed'"
                                    class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md"
                                >
                                    上一页
                                </button>

                                <!-- 页码 -->
                                <template
                                    x-for="page in Array.from({length: Math.min(5, proxyKeyPagination.total_pages)}, (_, i) => {
                                const start = Math.max(1, proxyKeyPagination.page - 2);
                                const end = Math.min(proxyKeyPagination.total_pages, start + 4);
                                const adjustedStart = Math.max(1, end - 4);
                                return adjustedStart + i;
                            }).filter(p => p <= proxyKeyPagination.total_pages)"
                                    :key="page"
                                >
                                    <button
                                        @click="goToProxyKeyPage(page)"
                                        :class="page === proxyKeyPagination.page ? 'bg-indigo-500 text-white' : 'text-gray-500 hover:text-gray-700'"
                                        class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md"
                                    >
                                        <span x-text="page"></span>
                                    </button>
                                </template>

                                <!-- 下一页 -->
                                <button
                                    @click="goToProxyKeyPage(proxyKeyPagination.page + 1)"
                                    :disabled="!proxyKeyPagination.has_next"
                                    :class="proxyKeyPagination.has_next ? 'text-gray-500 hover:text-gray-700' : 'text-gray-300 cursor-not-allowed'"
                                    class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-md"
                                >
                                    下一页
                                </button>
                            </div>
                        </div>

                        <!-- 编辑代理密钥模态框 -->
                        <div
                            x-show="showEditProxyKeyModal"
                            x-cloak
                            class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
                        >
                            <div
                                class="relative top-10 mx-auto p-6 border max-w-4xl shadow-lg rounded-lg bg-white"
                            >
                                <div class="mt-3">
                                    <h3
                                        class="text-xl font-bold text-gray-900 mb-6 flex items-center"
                                    >
                                        <svg
                                            class="w-6 h-6 mr-2 text-indigo-600"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                            ></path>
                                        </svg>
                                        编辑代理密钥
                                    </h3>
                                    <form
                                        @submit.prevent="updateProxyKey()"
                                        class="space-y-6"
                                    >
                                        <!-- 基本信息 -->
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <h4
                                                class="text-sm font-medium text-gray-800 mb-4"
                                            >
                                                基本信息
                                            </h4>
                                            <div
                                                class="grid grid-cols-1 md:grid-cols-2 gap-4"
                                            >
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-gray-700 mb-2"
                                                        >密钥名称 *</label
                                                    >
                                                    <input
                                                        type="text"
                                                        x-model="editingProxyKey.name"
                                                        required
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                        placeholder="输入密钥名称"
                                                    />
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-sm font-medium text-gray-700 mb-2"
                                                        >描述</label
                                                    >
                                                    <input
                                                        type="text"
                                                        x-model="editingProxyKey.description"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                        placeholder="输入描述信息"
                                                    />
                                                </div>
                                            </div>
                                            <div class="mt-4">
                                                <label
                                                    class="flex items-center"
                                                >
                                                    <input
                                                        type="checkbox"
                                                        x-model="editingProxyKey.is_active"
                                                        class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                    />
                                                    <span
                                                        class="ml-2 text-sm font-medium text-gray-700"
                                                        >启用密钥</span
                                                    >
                                                </label>
                                            </div>
                                        </div>

                                        <!-- 分组权限 -->
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <h4
                                                class="text-sm font-medium text-gray-800 mb-4"
                                            >
                                                分组权限
                                            </h4>
                                            <div
                                                class="bg-white rounded-lg border border-gray-200 p-3"
                                            >
                                                <label
                                                    class="block text-sm font-medium text-gray-700 mb-3"
                                                    >允许访问的分组</label
                                                >
                                                <div
                                                    class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto"
                                                >
                                                    <template
                                                        x-for="(provider, groupId) in providerStatuses"
                                                        :key="groupId"
                                                    >
                                                        <label
                                                            class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded"
                                                        >
                                                            <input
                                                                type="checkbox"
                                                                :value="groupId"
                                                                :checked="editingProxyKey.allowedGroups.includes(groupId)"
                                                                @change="toggleEditingProxyKeyGroup(groupId, $event.target.checked)"
                                                                class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                            />
                                                            <span
                                                                class="text-sm"
                                                                x-text="provider.group_name"
                                                            ></span>
                                                        </label>
                                                    </template>
                                                </div>
                                                <p
                                                    class="text-xs text-gray-500 mt-2"
                                                >
                                                    不选择任何分组表示可以访问所有分组
                                                </p>
                                            </div>
                                        </div>

                                        <!-- 分组间请求设置 -->
                                        <div
                                            x-show="editingProxyKey.allowedGroups.length > 1 || editingProxyKey.allowedGroups.length === 0"
                                            class="bg-gray-50 rounded-lg p-4"
                                        >
                                            <h4
                                                class="text-sm font-medium text-gray-800 mb-4 flex items-center"
                                            >
                                                <svg
                                                    class="w-4 h-4 mr-2 text-blue-500"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M8 9l3 3-3 3m5 0h3"
                                                    ></path>
                                                </svg>
                                                分组间请求设置
                                            </h4>
                                            <div
                                                class="bg-white rounded-lg border border-gray-200 p-3"
                                            >
                                                <div class="mb-4">
                                                    <label
                                                        class="block text-sm font-medium text-gray-700 mb-2"
                                                        >选择策略</label
                                                    >
                                                    <select
                                                        x-model="editingProxyKey.groupSelectionConfig.strategy"
                                                        @change="onEditingProxyKeyStrategyChange()"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                                    >
                                                        <option
                                                            value="round_robin"
                                                        >
                                                            轮询 (Round Robin) -
                                                            在分组间轮流分配请求
                                                        </option>
                                                        <option
                                                            value="weighted"
                                                        >
                                                            权重 (Weighted) -
                                                            根据权重比例分配请求
                                                        </option>
                                                        <option value="random">
                                                            随机 (Random) -
                                                            随机选择分组
                                                        </option>
                                                        <option
                                                            value="failover"
                                                        >
                                                            故障转移 (Failover)
                                                            - 按优先级顺序选择
                                                        </option>
                                                    </select>
                                                </div>

                                                <!-- 权重配置 -->
                                                <div
                                                    x-show="editingProxyKey.groupSelectionConfig.strategy === 'weighted'"
                                                    class="mt-4"
                                                >
                                                    <label
                                                        class="block text-sm font-medium text-gray-700 mb-3"
                                                        >分组权重配置</label
                                                    >
                                                    <div class="space-y-2">
                                                        <template
                                                            x-for="groupId in getGroupsForWeightConfig(editingProxyKey.allowedGroups)"
                                                            :key="groupId"
                                                        >
                                                            <div
                                                                class="flex items-center space-x-3 p-2 bg-gray-50 rounded"
                                                            >
                                                                <span
                                                                    class="text-sm font-medium min-w-0 flex-1"
                                                                    x-text="getGroupName(groupId)"
                                                                ></span>
                                                                <div
                                                                    class="flex items-center space-x-2"
                                                                >
                                                                    <label
                                                                        class="text-xs text-gray-600"
                                                                        >权重:</label
                                                                    >
                                                                    <input
                                                                        type="number"
                                                                        :value="getEditingGroupWeight(groupId)"
                                                                        @input="setEditingGroupWeight(groupId, $event.target.value)"
                                                                        min="1"
                                                                        max="100"
                                                                        class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500"
                                                                    />
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    <p
                                                        class="text-xs text-gray-500 mt-2"
                                                    >
                                                        权重越高，获得的请求越多。例如权重3:1的分组将获得约75%:25%的请求分配。
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div
                                            class="flex space-x-2 pt-4 border-t border-gray-200"
                                        >
                                            <button
                                                type="submit"
                                                class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-md flex items-center"
                                            >
                                                <svg
                                                    class="w-4 h-4 mr-2"
                                                    fill="none"
                                                    stroke="currentColor"
                                                    viewBox="0 0 24 24"
                                                >
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M5 13l4 4L19 7"
                                                    ></path>
                                                </svg>
                                                更新密钥
                                            </button>
                                            <button
                                                type="button"
                                                @click="closeEditProxyKeyModal()"
                                                class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md"
                                            >
                                                取消
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div
                x-show="message"
                x-cloak
                x-transition
                class="fixed top-4 right-4 z-50"
            >
                <div
                    class="px-4 py-2 rounded-md text-white"
                    :class="messageType === 'success' ? 'bg-green-500' : 'bg-red-500'"
                >
                    <span x-text="message"></span>
                </div>
            </div>
        </div>

        <script>
            function multiProviderDashboard() {
                return {
                    systemHealth: {
                        status: "healthy",
                        total_groups: 0,
                        healthy_groups: 0,
                        total_keys: 0,
                        active_keys: 0,
                        uptime: 0,
                    },
                    providerStatuses: {},
                    providerModels: {},
                    selectedProvider: "",
                    loadingModels: false,
                    lastUpdate: new Date(),

                    // 分组导出相关
                    selectedGroups: [],

                    // 分组导入相关
                    showImportModal: false,
                    selectedFile: null,
                    importing: false,

                    // 密钥状态相关
                    keyStatus: {
                        total_keys: 0,
                        total_valid: 0,
                        total_invalid: 0,
                        last_updated: null,
                        groups: {},
                    },

                    // 代理密钥管理相关
                    showProxyKeyModal: false,
                    showGenerateProxyKeyForm: false,
                    showEditProxyKeyModal: false,
                    proxyKeys: [],
                    newProxyKey: {
                        name: "",
                        description: "",
                        allowedGroups: [],
                        groupSelectionConfig: {
                            strategy: "round_robin",
                            groupWeights: [],
                        },
                    },
                    editingProxyKey: {
                        id: "",
                        name: "",
                        description: "",
                        is_active: true,
                        allowedGroups: [],
                        groupSelectionConfig: {
                            strategy: "round_robin",
                            groupWeights: [],
                        },
                    },
                    // 代理密钥分页、搜索和排序
                    proxyKeySearch: "",
                    proxyKeySortBy: "created_time_desc", // 默认按创建时间倒序
                    proxyKeyPage: 1,
                    proxyKeyPageSize: 10,
                    proxyKeyPagination: {
                        page: 1,
                        page_size: 10,
                        total: 0,
                        total_pages: 0,
                        has_prev: false,
                        has_next: false,
                    },
                    loadingKeyStatus: false,
                    loadingValidation: false,
                    loadingSystemHealth: false,
                    loadingProviderStatuses: false,
                    loadingHealthRefresh: false,
                    keyStatusTimer: null,

                    // 提供商筛选和分页
                    providerSearchQuery: "",
                    providerStatusFilter: "",
                    providerTypeFilter: "",
                    filteredProviders: [],
                    providerPage: 1,
                    providersPerPage: 5,
                    validatingAllKeys: false,
                    validatingGroups: {}, // 跟踪每个分组的验证状态

                    // 分组管理相关
                    showCreateGroupModal: false,
                    showEditGroupModal: false,
                    showBatchAddModal: false,
                    submittingGroup: false,
                    editingGroupId: "",
                    message: "",
                    messageType: "success",

                    // 密钥分页相关
                    selectedKeys: [],
                    keyPage: 1,
                    keysPerPage: 5,
                    batchKeysText: "",

                    // 密钥验证相关
                    validatingKeys: false,
                    keyValidationStatus: {}, // 存储每个密钥的验证状态
                    invalidKeyIndexes: [], // 存储无效密钥的索引
                    forcingKeyStatus: {}, // 存储正在强制设置状态的密钥索引
                    bulkDeletingInvalidKeys: false, // 一键删除失效密钥的状态

                    // 模型相关
                    availableModels: [],
                    filteredModels: [],
                    loadingModels: false,
                    refreshingModels: false,
                    modelSearchQuery: "",
                    modelCapabilityFilter: 'all',
                    modelLoadError: null,
                    modelCacheTimestamp: null,

                    groupFormData: {
                        group_id: "",
                        name: "",
                        provider_type: "",
                        base_url: "",
                        api_version: "",
                        enabled: true,
                        timeout: 30,
                        max_retries: 3,
                        rotation_strategy: "round_robin",
                        api_keys: [""],
                        models: [],
                        use_native_response: false,
                        rpm_limit: 0,
                        headers: {}, // HTTP headers
                        disable_permanent_ban: false,
                        max_error_count: 10,
                        rate_limit_cooldown: 0,
                    },
                    modelsText: "",

                    // Headers参数相关
                    headers: [], // 当前编辑的headers（key-value对象数组）
                    showHeadersHelp: false,
                    headersJsonText: "", // JSON格式的headers输入
                    headersJsonValidationMessage: "",
                    headersJsonValidationError: false,

                    // JSON请求参数相关
                    requestParamsText: "",
                    showRequestParamsHelp: false,
                    requestParamsValidationMessage: "",
                    requestParamsValidationError: false,

                    // 模型重命名相关
                    modelMappings: [],
                    showModelMappingHelp: false,

                    // 计算属性
                    get providerPageOffset() {
                        return (this.providerPage - 1) * this.providersPerPage;
                    },

                    get paginatedProviders() {
                        const start = this.providerPageOffset;
                        const end = start + this.providersPerPage;
                        const providersArray = Object.entries(
                            this.filteredProviders,
                        );
                        return providersArray
                            .slice(start, end)
                            .reduce((acc, [groupId, provider]) => {
                                acc[groupId] = provider;
                                return acc;
                            }, {});
                    },

                    get totalProviderPages() {
                        return Math.ceil(
                            Object.keys(this.filteredProviders).length /
                                this.providersPerPage,
                        );
                    },

                    // 分组管理计算属性
                    get keyPageOffset() {
                        return (this.keyPage - 1) * this.keysPerPage;
                    },

                    get paginatedKeys() {
                        const start = this.keyPageOffset;
                        const end = start + this.keysPerPage;
                        return this.groupFormData.api_keys.slice(start, end);
                    },

                    get totalKeyPages() {
                        return Math.ceil(
                            this.groupFormData.api_keys.length /
                                this.keysPerPage,
                        );
                    },

                    // 系统状态计算属性（已移除平均响应时间计算）

                    async init() {
                        // 初始化验证状态对象
                        this.validatingGroups = {};

                        // 系统健康状态和提供商分组状态需要默认展示
                        await this.loadSystemHealth();
                        await this.loadProviderStatuses();
                        await this.loadProxyKeys();

                        // 加载已保存的验证状态（初始化时不显示消息）
                        await this.loadPersistedValidationStatus(false);
                        this.filterProviders();

                        // 启动系统健康状态的定时刷新（只刷新第一排的系统信息）
                        this.startSystemHealthRefresh();

                        // 添加页面可见性变化监听器，确保用户回到页面时统计数据是最新的
                        document.addEventListener("visibilitychange", () => {
                            if (!document.hidden) {
                                // 页面变为可见时，只刷新统计数据，不刷新列表
                                this.loadSystemHealth();
                                this.refreshProxyKeysOnly();
                            }
                        });
                    },

                    async loadSystemHealth() {
                        this.loadingSystemHealth = true;
                        try {
                            const response = await fetch(
                                "/admin/health/system",
                            );
                            if (response.ok) {
                                this.systemHealth = await response.json();
                                // this.showMessage('系统健康状态已更新', 'success');
                            } else {
                                throw new Error("获取系统健康状态失败");
                            }
                        } catch (error) {
                            console.error(
                                "Failed to load system health:",
                                error,
                            );
                            this.showMessage(
                                "加载系统健康状态失败: " + error.message,
                                "error",
                            );
                        } finally {
                            this.loadingSystemHealth = false;
                        }
                    },

                    async loadProviderStatuses() {
                        this.loadingProviderStatuses = true;
                        try {
                            const response = await fetch("/admin/groups");
                            if (response.ok) {
                                const data = await response.json();
                                this.providerStatuses = data.groups || {};
                                this.filterProviders();
                                // this.showMessage('提供商分组状态已更新', 'success');
                            } else {
                                throw new Error("获取提供商分组状态失败");
                            }
                        } catch (error) {
                            console.error(
                                "Failed to load provider statuses:",
                                error,
                            );
                            this.showMessage(
                                "加载提供商分组状态失败: " + error.message,
                                "error",
                            );
                        } finally {
                            this.loadingProviderStatuses = false;
                        }
                    },

                    async refreshData() {
                        // 手动刷新时刷新所有数据
                        await this.refreshSystemData();
                    },

                    async refreshProviderHealth() {
                        await this.loadProviderStatuses();
                        this.lastUpdate = new Date();
                    },

                    // 导出分组配置
                    async exportGroups() {
                        try {
                            let groupsToExport = [];

                            if (this.selectedGroups.length === 0) {
                                // 如果没有选中任何分组，导出所有分组
                                if (confirm('没有选中任何分组，是否导出所有分组？')) {
                                    groupsToExport = Object.keys(this.providerStatuses);
                                } else {
                                    return;
                                }
                            } else {
                                groupsToExport = this.selectedGroups;
                            }

                            const response = await fetch('/admin/groups/export', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    group_ids: groupsToExport
                                })
                            });

                            if (response.ok) {
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.style.display = 'none';
                                a.href = url;
                                a.download = `groups_config_${new Date().toISOString().split('T')[0]}.yaml`;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);

                                alert(`成功导出 ${groupsToExport.length} 个分组的配置`);
                            } else {
                                const errorData = await response.json();
                                alert('导出失败: ' + (errorData.error || '未知错误'));
                            }
                        } catch (error) {
                            console.error('Export error:', error);
                            alert('导出失败: ' + error.message);
                        }
                    },

                    // 处理文件选择
                    handleFileSelect(event) {
                        this.selectedFile = event.target.files[0];
                    },

                    // 导入分组配置
                    async importGroups() {
                        if (!this.selectedFile) {
                            alert('请选择配置文件');
                            return;
                        }

                        this.importing = true;

                        try {
                            const formData = new FormData();
                            formData.append('config_file', this.selectedFile);

                            const response = await fetch('/admin/groups/import', {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();

                            if (data.success) {
                                let message = `成功导入 ${data.imported_count}/${data.total_groups} 个分组`;

                                if (data.errors && data.errors.length > 0) {
                                    message += '\n\n错误信息:\n' + data.errors.join('\n');
                                }

                                alert(message);

                                // 重新加载提供商状态
                                await this.loadProviderStatuses();

                                // 关闭模态框并重置状态
                                this.showImportModal = false;
                                this.selectedFile = null;

                                // 重置文件输入
                                const fileInput = document.querySelector('input[type="file"]');
                                if (fileInput) {
                                    fileInput.value = '';
                                }
                            } else {
                                alert('导入失败: ' + (data.error || '未知错误'));
                            }
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('导入失败: ' + error.message);
                        } finally {
                            this.importing = false;
                        }
                    },

                    async checkProviderHealth(groupId) {
                        try {
                            const response = await fetch(
                                `/admin/health/providers/${groupId}`,
                            );
                            if (response.ok) {
                                const data = await response.json();
                                this.providerStatuses[groupId] = data;
                            }
                        } catch (error) {
                            console.error(
                                "Failed to check provider health:",
                                error,
                            );
                        }
                    },

                    async loadProviderModels() {
                        this.loadingModels = true;
                        try {
                            const url = this.selectedProvider
                                ? `/admin/models/${this.selectedProvider}`
                                : "/admin/models";

                            const response = await fetch(url);
                            if (response.ok) {
                                const data = await response.json();
                                this.providerModels = data.data || {};
                            }
                        } catch (error) {
                            console.error("Failed to load models:", error);
                        } finally {
                            this.loadingModels = false;
                        }
                    },

                    // 移除自动刷新功能
                    // toggleAutoRefresh() {
                    //     this.autoRefresh = !this.autoRefresh;
                    //     if (this.autoRefresh) {
                    //         this.startAutoRefresh();
                    //     } else {
                    //         this.stopAutoRefresh();
                    //     }
                    // },

                    // 密钥状态相关方法
                    async loadKeyStatus() {
                        this.loadingKeyStatus = true;
                        try {
                            const response = await fetch("/admin/keys/status");
                            if (response.ok) {
                                const data = await response.json();
                                if (data.success) {
                                    // 计算总计数据
                                    let totalKeys = 0;
                                    let totalValid = 0;
                                    let totalInvalid = 0;

                                    for (const groupId in data.data) {
                                        const groupData = data.data[groupId];
                                        totalKeys += groupData.total_keys;
                                        totalValid += groupData.valid_keys;
                                        totalInvalid += groupData.invalid_keys;
                                    }

                                    this.keyStatus = {
                                        total_keys: totalKeys,
                                        total_valid: totalValid,
                                        total_invalid: totalInvalid,
                                        last_updated: new Date().toLocaleString(
                                            "zh-CN",
                                        ),
                                        groups: data.data,
                                    };
                                }
                            }
                        } catch (error) {
                            console.error("Failed to load key status:", error);
                        } finally {
                            this.loadingKeyStatus = false;
                        }
                    },

                    async refreshKeyStatus() {
                        await this.loadKeyStatus();
                        // 移除自动加载验证状态，改为手动触发
                        // await this.loadPersistedValidationStatus();
                    },

                    // 加载所有分组的持久化验证状态
                    async loadPersistedValidationStatus(showMessage = true) {
                        this.loadingValidation = true;
                        try {
                            // 获取所有分组ID
                            const groupIds = Object.keys(
                                this.providerStatuses || {},
                            );
                            let processedGroups = 0;

                            // 为每个分组加载验证状态
                            for (const groupId of groupIds) {
                                try {
                                    const response = await fetch(
                                        `/admin/keys/validation/${groupId}`,
                                    );
                                    if (response.ok) {
                                        const data = await response.json();
                                        if (
                                            data.success &&
                                            data.validation_status
                                        ) {
                                            // 统计验证状态
                                            const validationStatus =
                                                data.validation_status;
                                            let validCount = 0;
                                            let invalidCount = 0;
                                            let totalCount = 0;

                                            for (const [
                                                apiKey,
                                                status,
                                            ] of Object.entries(
                                                validationStatus,
                                            )) {
                                                totalCount++;
                                                if (status.is_valid === true) {
                                                    validCount++;
                                                } else if (
                                                    status.is_valid === false
                                                ) {
                                                    invalidCount++;
                                                }
                                            }

                                            // 更新密钥状态数据
                                            if (!this.keyStatus.groups) {
                                                this.keyStatus.groups = {};
                                            }
                                            this.keyStatus.groups[groupId] = {
                                                valid_keys: validCount,
                                                invalid_keys: invalidCount,
                                                total_keys: totalCount,
                                                last_validated:
                                                    new Date().toISOString(),
                                            };
                                        }
                                    }
                                    processedGroups++;
                                } catch (error) {
                                    console.error(
                                        `Failed to load validation status for group ${groupId}:`,
                                        error,
                                    );
                                    processedGroups++;
                                }
                            }

                            // 重新计算总计数据
                            if (this.keyStatus.groups) {
                                let totalKeys = 0;
                                let totalValid = 0;
                                let totalInvalid = 0;

                                for (const groupData of Object.values(
                                    this.keyStatus.groups,
                                )) {
                                    totalKeys += groupData.total_keys || 0;
                                    totalValid += groupData.valid_keys || 0;
                                    totalInvalid += groupData.invalid_keys || 0;
                                }

                                this.keyStatus.total_keys = totalKeys;
                                this.keyStatus.total_valid = totalValid;
                                this.keyStatus.total_invalid = totalInvalid;
                                this.keyStatus.last_updated =
                                    new Date().toLocaleString();
                            }

                            // 显示完成消息（仅在手动调用时显示）
                            if (showMessage) {
                                this.showMessage(
                                    `已检查 ${processedGroups} 个分组的密钥验证状态`,
                                    "success",
                                );
                            }
                        } catch (error) {
                            console.error(
                                "Failed to load persisted validation status:",
                                error,
                            );
                            this.showMessage(
                                "加载密钥验证状态失败: " + error.message,
                                "error",
                            );
                        } finally {
                            this.loadingValidation = false;
                        }
                    },

                    // 提供商筛选和管理方法
                    filterProviders(resetPage = true) {
                        let providers = Object.entries(this.providerStatuses);

                        // 按创建时间倒序排序（后端已经排序，但为了确保一致性）
                        providers.sort(([, a], [, b]) => {
                            const aTime = a.created_at
                                ? new Date(a.created_at)
                                : new Date(0);
                            const bTime = b.created_at
                                ? new Date(b.created_at)
                                : new Date(0);
                            return bTime - aTime; // 倒序
                        });

                        // 搜索筛选
                        if (this.providerSearchQuery.trim()) {
                            const query =
                                this.providerSearchQuery.toLowerCase();
                            providers = providers.filter(
                                ([groupId, provider]) =>
                                    provider.group_name
                                        .toLowerCase()
                                        .includes(query) ||
                                    provider.provider_type
                                        .toLowerCase()
                                        .includes(query) ||
                                    groupId.toLowerCase().includes(query),
                            );
                        }

                        // 状态筛选
                        if (this.providerStatusFilter) {
                            providers = providers.filter(
                                ([groupId, provider]) => {
                                    if (
                                        this.providerStatusFilter === "healthy"
                                    ) {
                                        return provider.healthy;
                                    } else if (
                                        this.providerStatusFilter ===
                                        "unhealthy"
                                    ) {
                                        return !provider.healthy;
                                    }
                                    return true;
                                },
                            );
                        }

                        // 类型筛选
                        if (this.providerTypeFilter) {
                            providers = providers.filter(
                                ([groupId, provider]) =>
                                    provider.provider_type ===
                                    this.providerTypeFilter,
                            );
                        }

                        // 转换为对象格式，保持排序顺序
                        this.filteredProviders = {};
                        providers.forEach(([groupId, provider]) => {
                            this.filteredProviders[groupId] = provider;
                        });

                        // 重置页码（可选）
                        if (resetPage) {
                            this.providerPage = 1;
                        }
                    },

                    async validateAllKeys() {
                        this.validatingAllKeys = true;
                        try {
                            await this.loadKeyStatus();
                            // 检查是否有失效密钥
                            const hasInvalidKeys =
                                this.keyStatus.total_invalid > 0;
                            if (hasInvalidKeys) {
                                // 如果有失效密钥，可以选择打开分组管理页面
                                if (
                                    confirm(
                                        `发现 ${this.keyStatus.total_invalid} 个失效密钥，是否打开分组管理页面进行处理？`,
                                    )
                                ) {
                                    window.open("/groups", "_blank");
                                }
                            } else {
                                alert("所有密钥都是有效的！");
                            }
                        } catch (error) {
                            console.error("Failed to validate keys:", error);
                            alert("验证密钥时出错，请稍后重试");
                        } finally {
                            this.validatingAllKeys = false;
                        }
                    },

                    // 验证单个分组的密钥
                    async validateGroupKeys(groupId, provider) {
                        // 确保 validatingGroups 对象存在并设置验证状态
                        if (!this.validatingGroups) {
                            this.validatingGroups = {};
                        }

                        // 设置验证状态为 true - 使用对象展开确保响应式更新
                        this.validatingGroups = {
                            ...this.validatingGroups,
                            [groupId]: true
                        };

                        // 定义清除验证状态的辅助函数
                        const clearValidatingState = () => {
                            this.validatingGroups = {
                                ...this.validatingGroups,
                                [groupId]: false
                            };
                        };

                        try {
                            // 获取分组的完整数据
                            const response = await fetch(
                                "/admin/groups/manage",
                            );
                            if (!response.ok) {
                                throw new Error("Failed to fetch group data");
                            }

                            const data = await response.json();
                            const groupData = data.groups[groupId];

                            if (
                                !groupData ||
                                !groupData.api_keys ||
                                groupData.api_keys.length === 0
                            ) {
                                alert("该分组没有配置API密钥");
                                clearValidatingState();
                                return;
                            }

                            // 过滤掉空密钥
                            const validKeys = groupData.api_keys.filter(
                                (key) => key && key.trim().length > 0,
                            );

                            if (validKeys.length === 0) {
                                alert("该分组没有有效的API密钥");
                                clearValidatingState();
                                return;
                            }

                            // 发送验证请求
                            const validateResponse = await fetch(
                                `/admin/keys/validate/${groupId}`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        api_keys: validKeys,
                                    }),
                                },
                            );

                            if (!validateResponse.ok) {
                                throw new Error("验证请求失败");
                            }

                            const result = await validateResponse.json();

                            if (result.success) {
                                const validCount = result.valid_keys || 0;
                                const invalidCount = result.invalid_keys || 0;
                                const unknownCount = result.unknown_keys || 0;
                                const totalCount = result.total_keys || 0;

                                // 更新本地密钥状态数据
                                if (!this.keyStatus.groups) {
                                    this.keyStatus.groups = {};
                                }
                                this.keyStatus.groups[groupId] = {
                                    valid_keys: validCount,
                                    invalid_keys: invalidCount,
                                    unknown_keys: unknownCount,
                                    total_keys: totalCount,
                                    last_validated: new Date().toISOString(),
                                };

                                // 显示结果
                                const unknownLine =
                                    unknownCount > 0
                                        ? `❓ 未知（可能限速/临时错误）：${unknownCount}\n`
                                        : "";
                                const message =
                                    `分组 "${provider.group_name}" 密钥验证完成：\n\n` +
                                    `✅ 有效密钥：${validCount}\n` +
                                    `❌ 无效密钥：${invalidCount}\n` +
                                    unknownLine +
                                    `📊 总计：${totalCount}\n\n` +
                                    `验证结果已保存到密钥管理列表中`;

                                alert(message);

                                // 刷新提供商状态和密钥状态（在后台执行，不阻塞状态更新）
                                setTimeout(async () => {
                                    try {
                                        await this.loadProviderStatuses();
                                        await this.refreshKeyStatus();
                                    } catch (refreshError) {
                                        console.error(
                                            "刷新状态失败:",
                                            refreshError
                                        );
                                    }
                                }, 0);
                            } else {
                                throw new Error(result.message || "验证失败");
                            }
                        } catch (error) {
                            console.error("验证分组密钥失败:", error);
                            alert(`验证分组密钥失败：${error.message}`);
                        } finally {
                            // 清除验证状态 - 使用对象展开确保响应式更新
                            clearValidatingState();
                        }
                    },

                    showProviderDetails(groupId, provider) {
                        const keyStatusData = this.keyStatus.groups[groupId];
                        let detailsHtml = `
                        <div class="space-y-4">
                            <div>
                                <h3 class="text-lg font-semibold">${provider.group_name} (${groupId})</h3>
                                <p class="text-sm text-gray-600">${provider.provider_type.toUpperCase()}</p>
                            </div>

                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">状态:</span>
                                    <span class="${provider.healthy ? "text-green-600" : "text-red-600"}">${provider.healthy ? "健康" : "异常"}</span>
                                </div>
                                <div>
                                    <span class="font-medium">响应时间:</span>
                                    <span>${this.formatResponseTime(provider.response_time)}</span>
                                </div>
                                <div>
                                    <span class="font-medium">总密钥数:</span>
                                    <span>${provider.total_keys}</span>
                                </div>
                                <div>
                                    <span class="font-medium">活跃密钥:</span>
                                    <span>${provider.active_keys}</span>
                                </div>
                            </div>
                    `;

                        if (keyStatusData) {
                            detailsHtml += `
                            <div class="border-t pt-4">
                                <h4 class="font-medium mb-2">密钥验证状态:</h4>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-green-600">${keyStatusData.valid_keys}</div>
                                        <div class="text-gray-600">有效</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-red-600">${keyStatusData.invalid_keys}</div>
                                        <div class="text-gray-600">无效</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-semibold text-gray-600">${keyStatusData.total_keys}</div>
                                        <div class="text-gray-600">总计</div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">测试模型: ${keyStatusData.test_model}</p>
                            </div>
                        `;
                        }

                        if (provider.last_error) {
                            detailsHtml += `
                            <div class="border-t pt-4">
                                <h4 class="font-medium mb-2 text-red-600">错误信息:</h4>
                                <p class="text-sm text-red-700 bg-red-50 p-2 rounded">${provider.last_error}</p>
                            </div>
                        `;
                        }

                        detailsHtml += "</div>";

                        // 这里可以使用一个模态框来显示详情，暂时使用alert
                        const tempDiv = document.createElement("div");
                        tempDiv.innerHTML = detailsHtml;
                        alert(
                            `${provider.group_name} 详细信息\n\n状态: ${provider.healthy ? "健康" : "异常"}\n响应时间: ${this.formatResponseTime(provider.response_time)}\n密钥: ${provider.active_keys}/${provider.total_keys}`,
                        );
                    },

                    // 分组管理方法
                    openCreateGroupModal() {
                        this.resetGroupForm();
                        this.showCreateGroupModal = true;
                    },

                    // 强制刷新表单UI显示
                    forceRefreshFormUI() {
                        setTimeout(() => {
                            // 获取所有需要更新的表单元素
                            const formElements = [
                                {
                                    selector:
                                        'input[x-model="groupFormData.rpm_limit"]',
                                    value: this.groupFormData.rpm_limit,
                                    event: "input",
                                },
                                {
                                    selector:
                                        'input[x-model="groupFormData.use_native_response"]',
                                    value: this.groupFormData
                                        .use_native_response,
                                    event: "change",
                                    isCheckbox: true,
                                },
                                {
                                    selector:
                                        'input[x-model="groupFormData.timeout"]',
                                    value: this.groupFormData.timeout,
                                    event: "input",
                                },
                                {
                                    selector:
                                        'input[x-model="groupFormData.max_retries"]',
                                    value: this.groupFormData.max_retries,
                                    event: "input",
                                },
                            ];

                            formElements.forEach((element) => {
                                const el = document.querySelector(
                                    element.selector,
                                );
                                if (el) {
                                    if (element.isCheckbox) {
                                        el.checked = Boolean(element.value);
                                    } else {
                                        el.value = element.value;
                                    }
                                    el.dispatchEvent(
                                        new Event(element.event, {
                                            bubbles: true,
                                        }),
                                    );
                                }
                            });
                        }, 100);
                    },

                    async editGroup(groupId, provider) {
                        this.editingGroupId = groupId;

                        try {
                            // 从分组管理接口获取完整的分组数据
                            const response = await fetch(
                                "/admin/groups/manage",
                            );
                            if (!response.ok) {
                                throw new Error("Failed to fetch group data");
                            }

                            const data = await response.json();
                            const fullGroupData = data.groups[groupId];

                            if (!fullGroupData) {
                                throw new Error("Group data not found");
                            }

                            // 确保API密钥数组至少有一个空元素
                            let apiKeys = [""];
                            if (
                                fullGroupData.api_keys &&
                                Array.isArray(fullGroupData.api_keys) &&
                                fullGroupData.api_keys.length > 0
                            ) {
                                apiKeys = [...fullGroupData.api_keys];
                            }

                            this.groupFormData = {
                                group_id: groupId,
                                name: fullGroupData.group_name || "",
                                provider_type:
                                    fullGroupData.provider_type || "",
                                base_url: fullGroupData.base_url || "",
                                api_version: fullGroupData.api_version || "",
                                enabled: fullGroupData.enabled !== false,
                                timeout: parseInt(fullGroupData.timeout) || 30,
                                max_retries:
                                    parseInt(fullGroupData.max_retries) || 3,
                                rotation_strategy:
                                    fullGroupData.rotation_strategy ||
                                    "round_robin",
                                api_keys: apiKeys,
                                models: fullGroupData.models || [],
                                use_native_response: Boolean(
                                    fullGroupData.use_native_response,
                                ),
                                rpm_limit:
                                    parseInt(fullGroupData.rpm_limit) || 0,
                                headers: fullGroupData.headers || {},
                                disable_permanent_ban: Boolean(
                                    fullGroupData.disable_permanent_ban,
                                ),
                                max_error_count:
                                    parseInt(fullGroupData.max_error_count) || 10,
                                rate_limit_cooldown:
                                    parseInt(fullGroupData.rate_limit_cooldown) || 0,
                            };

                            this.modelsText = (fullGroupData.models || []).join(
                                "\n",
                            );

                            // 加载Headers
                            this.loadHeadersFromGroup(fullGroupData);

                            // 加载JSON请求参数
                            if (
                                fullGroupData.request_params &&
                                Object.keys(fullGroupData.request_params)
                                    .length > 0
                            ) {
                                this.requestParamsText = JSON.stringify(
                                    fullGroupData.request_params,
                                    null,
                                    2,
                                );
                            } else {
                                this.requestParamsText = "";
                            }

                            // 加载模型映射
                            this.modelMappings = [];
                            if (
                                fullGroupData.model_mappings &&
                                Object.keys(fullGroupData.model_mappings)
                                    .length > 0
                            ) {
                                for (const [alias, original] of Object.entries(
                                    fullGroupData.model_mappings,
                                )) {
                                    this.modelMappings.push({
                                        alias: alias,
                                        original: original,
                                    });
                                }
                            }

                            // 使用setTimeout确保所有数据都已经设置完成
                            setTimeout(() => {
                                // 强制触发响应式更新
                                this.modelMappings = [...this.modelMappings];
                            }, 100);

                            this.selectedKeys = [];
                            this.keyPage = 1;
                            this.availableModels = [];
                            this.filteredModels = [];
                            this.modelSearchQuery = "";
                            this.keyValidationStatus = {};
                            this.invalidKeyIndexes = [];
                            this.requestParamsValidationMessage = "";
                            this.requestParamsValidationError = false;

                            this.showEditGroupModal = true;

                            // 延迟刷新表单UI，确保模态框完全显示后再刷新
                            setTimeout(() => {
                                this.forceRefreshFormUI();
                            }, 200);

                            // 自动加载验证状态以确保一键删除功能正常工作
                            await this.loadKeyValidationStatus(groupId);
                        } catch (error) {
                            console.error("获取分组数据失败:", error);
                            alert("获取分组数据失败，请稍后重试");
                        }
                    },

                    async toggleGroup(groupId, provider) {
                        try {
                            const response = await fetch(
                                `/admin/groups/${groupId}/toggle`,
                                {
                                    method: "POST",
                                },
                            );

                            const data = await response.json();

                            if (response.ok) {
                                this.showMessage(data.message, "success");
                                // 重新加载提供商状态以反映分组状态变化
                                await this.loadProviderStatuses();
                            } else {
                                this.showMessage(
                                    data.message || "操作失败",
                                    "error",
                                );
                            }
                        } catch (error) {
                            this.showMessage(
                                "网络错误: " + error.message,
                                "error",
                            );
                        }
                    },

                    async deleteGroup(groupId, provider) {
                        if (
                            !confirm(
                                `确定要删除分组 "${provider.group_name}" 吗？此操作不可恢复。`,
                            )
                        ) {
                            return;
                        }

                        try {
                            const response = await fetch(
                                `/admin/groups/${groupId}`,
                                {
                                    method: "DELETE",
                                },
                            );

                            const data = await response.json();

                            if (response.ok) {
                                this.showMessage(data.message, "success");
                                // 重新加载提供商状态以移除已删除的分组
                                await this.loadProviderStatuses();
                            } else {
                                this.showMessage(
                                    data.message || "删除失败",
                                    "error",
                                );
                            }
                        } catch (error) {
                            this.showMessage(
                                "网络错误: " + error.message,
                                "error",
                            );
                        }
                    },

                    async submitGroupForm() {
                        this.submittingGroup = true;
                        try {
                            // 保存当前的页面状态（用于编辑模式保持位置）
                            const currentPage = this.providerPage;
                            const currentSearchQuery = this.providerSearchQuery;
                            const currentStatusFilter =
                                this.providerStatusFilter;
                            const currentTypeFilter = this.providerTypeFilter;

                            // 处理模型列表 - 合并选择的模型和手动输入的模型
                            const manualModels = this.modelsText
                                .split("\n")
                                .map((line) => line.trim())
                                .filter((line) => line.length > 0);

                            // 去重合并模型列表
                            const allModels = [
                                ...new Set([
                                    ...this.groupFormData.models,
                                    ...manualModels,
                                ]),
                            ];
                            this.groupFormData.models = allModels;

                            // 过滤空的API密钥并去重
                            const validKeys = this.groupFormData.api_keys
                                .map(key => key.trim())
                                .filter(key => key.length > 0);
                            
                            // 去重处理
                            const uniqueKeys = [...new Set(validKeys)];
                            this.groupFormData.api_keys = uniqueKeys;
                            
                            // 如果发现重复密钥，显示提示
                            if (validKeys.length !== uniqueKeys.length) {
                                const duplicateCount = validKeys.length - uniqueKeys.length;
                                this.showMessage(
                                    `检测到 ${duplicateCount} 个重复密钥已自动去除`,
                                    "success"
                                );
                            }

                            // 处理JSON请求参数
                            if (this.requestParamsText.trim()) {
                                try {
                                    this.groupFormData.request_params =
                                        JSON.parse(
                                            this.requestParamsText.trim(),
                                        );
                                    this.requestParamsValidationMessage = "";
                                    this.requestParamsValidationError = false;
                                } catch (e) {
                                    this.requestParamsValidationMessage =
                                        "JSON格式错误: " + e.message;
                                    this.requestParamsValidationError = true;
                                    this.submittingGroup = false;
                                    return;
                                }
                            } else {
                                this.groupFormData.request_params = {};
                            }

                            // 处理模型映射
                            const modelMappings = {};
                            for (const mapping of this.modelMappings) {
                                if (
                                    mapping.alias &&
                                    mapping.alias.trim() &&
                                    mapping.original &&
                                    mapping.original.trim()
                                ) {
                                    const alias = mapping.alias.trim();
                                    const original = mapping.original.trim();

                                    // 检查是否已存在相同的别名
                                    if (modelMappings[alias] && modelMappings[alias] !== original) {
                                        // 如果别名已存在且映射到不同的原始模型，给出警告
                                        const message = `警告：别名 "${alias}" 已映射到模型 "${modelMappings[alias]}"，现在将被覆盖为 "${original}"。\n\n如果您想要多个模型都使用相同的别名，建议：\n1. 在不同的分组中分别设置映射\n2. 或者使用不同的别名（如 gpt-4-v1, gpt-4-v2）`;

                                        if (!confirm(message + '\n\n是否继续保存？')) {
                                            return; // 用户取消保存
                                        }
                                    }

                                    modelMappings[alias] = original;
                                }
                            }
                            this.groupFormData.model_mappings = modelMappings;

                            // 确保数字字段是正确的类型
                            this.groupFormData.timeout =
                                parseInt(this.groupFormData.timeout) || 30;
                            this.groupFormData.max_retries =
                                parseInt(this.groupFormData.max_retries) || 3;
                            this.groupFormData.rpm_limit =
                                parseInt(this.groupFormData.rpm_limit) || 0;

                            const url = this.showCreateGroupModal
                                ? "/admin/groups"
                                : `/admin/groups/${this.editingGroupId}`;
                            const method = this.showCreateGroupModal
                                ? "POST"
                                : "PUT";

                            const response = await fetch(url, {
                                method: method,
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(this.groupFormData),
                            });

                            const data = await response.json();

                            if (response.ok) {
                                this.showMessage(data.message, "success");

                                // 如果是编辑模式，更新本地数据而不重新加载整个列表
                                if (
                                    !this.showCreateGroupModal &&
                                    this.editingGroupId
                                ) {
                                    // 更新本地providerStatuses中的数据
                                    if (
                                        this.providerStatuses[
                                            this.editingGroupId
                                        ]
                                    ) {
                                        // 更新用户可编辑的字段，保留健康检查相关字段
                                        Object.assign(
                                            this.providerStatuses[
                                                this.editingGroupId
                                            ],
                                            {
                                                group_name:
                                                    this.groupFormData.name, // 注意：groupFormData中使用的是name字段
                                                provider_type:
                                                    this.groupFormData
                                                        .provider_type,
                                                base_url:
                                                    this.groupFormData.base_url,
                                                api_version:
                                                    this.groupFormData.api_version,
                                                models: this.groupFormData
                                                    .models,
                                                model_mappings:
                                                    this.groupFormData
                                                        .model_mappings,
                                                use_native_response:
                                                    this.groupFormData
                                                        .use_native_response,
                                                rpm_limit:
                                                    this.groupFormData
                                                        .rpm_limit,
                                                timeout:
                                                    this.groupFormData.timeout,
                                                max_retries:
                                                    this.groupFormData
                                                        .max_retries,
                                                request_params:
                                                    this.groupFormData
                                                        .request_params,
                                                headers:
                                                    this.groupFormData
                                                        .headers,
                                                enabled:
                                                    this.groupFormData.enabled,
                                                rotation_strategy:
                                                    this.groupFormData
                                                        .rotation_strategy,
                                                // 注意：不更新 healthy, last_check, response_time, last_error, total_keys, active_keys 等健康检查字段
                                            },
                                        );
                                    }

                                    this.closeGroupModal();

                                    // 恢复页面状态
                                    this.providerPage = currentPage;
                                    this.providerSearchQuery =
                                        currentSearchQuery;
                                    this.providerStatusFilter =
                                        currentStatusFilter;
                                    this.providerTypeFilter = currentTypeFilter;

                                    // 重新过滤提供商以反映更新，但不重置页面位置
                                    this.filterProviders(false);
                                } else {
                                    // 创建模式：重新加载提供商状态以显示新添加的分组
                                    this.closeGroupModal();
                                    await this.loadProviderStatuses();
                                }

                                // 额外的数据验证，确保保存的数据正确
                                setTimeout(async () => {
                                    if (
                                        this.editingGroupId &&
                                        this.providerStatuses[
                                            this.editingGroupId
                                        ]
                                    ) {
                                        const savedData =
                                            this.providerStatuses[
                                                this.editingGroupId
                                            ];
                                    }
                                }, 500);
                            } else {
                                this.showMessage(
                                    data.message || "操作失败",
                                    "error",
                                );
                            }
                        } catch (error) {
                            this.showMessage(
                                "网络错误: " + error.message,
                                "error",
                            );
                        } finally {
                            this.submittingGroup = false;
                        }
                    },

                    closeGroupModal() {
                        this.showCreateGroupModal = false;
                        this.showEditGroupModal = false;
                        this.showBatchAddModal = false;
                        this.editingGroupId = "";
                        this.resetGroupForm();
                    },

                    resetGroupForm() {
                        this.groupFormData = {
                            group_id: "",
                            name: "",
                            provider_type: "",
                            base_url: "",
                            api_version: "",
                            enabled: true,
                            timeout: 30,
                            max_retries: 3,
                            rotation_strategy: "round_robin",
                            api_keys: [""],
                            models: [],
                            use_native_response: false,
                            rpm_limit: 0,
                            headers: {},
                            disable_permanent_ban: false,
                            max_error_count: 10,
                            rate_limit_cooldown: 0,
                        };
                        this.modelsText = "";
                        this.selectedKeys = [];
                        this.keyPage = 1;
                        this.availableModels = [];
                        this.filteredModels = [];
                        this.modelSearchQuery = "";
                        this.batchKeysText = "";
                        this.keyValidationStatus = {};
                        this.invalidKeyIndexes = [];
                        this.forcingKeyStatus = {};
                        this.bulkDeletingInvalidKeys = false;

                        // 重置Headers相关字段
                        this.headers = [];
                        this.showHeadersHelp = false;
                        this.headersJsonText = "";
                        this.headersJsonValidationMessage = "";
                        this.headersJsonValidationError = false;

                        // 重置JSON参数相关字段
                        this.requestParamsText = "";
                        this.showRequestParamsHelp = false;
                        this.requestParamsValidationMessage = "";
                        this.requestParamsValidationError = false;

                        // 重置模型映射相关字段
                        this.modelMappings = [];
                        this.showModelMappingHelp = false;
                    },

                    // 提供商类型变化时自动填充Base URL
                    onProviderTypeChange() {
                        const defaultBaseUrls = {
                            openai: "https://api.openai.com/v1",
                            anthropic: "https://api.anthropic.com",
                            gemini: "https://generativelanguage.googleapis.com",
                            azure_openai:
                                "https://your-resource.openai.azure.com/openai/deployments/your-deployment-name",
                            openrouter: "https://openrouter.ai/api/v1",
                        };

                        const providerType = this.groupFormData.provider_type;
                        if (providerType && defaultBaseUrls[providerType]) {
                            // 只有当Base URL为空或者是默认值时才自动填充
                            const currentBaseUrl = this.groupFormData.base_url;
                            const isDefaultUrl =
                                Object.values(defaultBaseUrls).includes(
                                    currentBaseUrl,
                                );

                            if (!currentBaseUrl || isDefaultUrl) {
                                this.groupFormData.base_url =
                                    defaultBaseUrls[providerType];
                            }
                        }

                        // 为 Azure OpenAI 设置默认 API 版本
                        if (providerType === "azure_openai") {
                            if (!this.groupFormData.api_version) {
                                this.groupFormData.api_version = "2024-02-15-preview";
                            }
                        } else {
                            // 非 Azure OpenAI 时清空 api_version
                            this.groupFormData.api_version = "";
                        }
                    },

                    addGroupApiKey() {
                        this.groupFormData.api_keys.push("");
                    },

                    // 检查密钥是否重复的辅助函数
                    checkDuplicateKeys(keys) {
                        const keyMap = new Map();
                        const duplicates = [];
                        const unique = [];
                        
                        keys.forEach((key, index) => {
                            const trimmedKey = key.trim();
                            if (trimmedKey.length === 0) return;
                            
                            if (keyMap.has(trimmedKey)) {
                                duplicates.push({
                                    key: trimmedKey,
                                    indexes: [keyMap.get(trimmedKey), index]
                                });
                            } else {
                                keyMap.set(trimmedKey, index);
                                unique.push(trimmedKey);
                            }
                        });
                        
                        return {
                            duplicates,
                            unique,
                            hasDuplicates: duplicates.length > 0
                        };
                    },

                    // 去重密钥数组
                    deduplicateKeys(keys) {
                        const seen = new Set();
                        return keys.filter(key => {
                            const trimmedKey = key.trim();
                            if (trimmedKey.length === 0) return false;
                            if (seen.has(trimmedKey)) return false;
                            seen.add(trimmedKey);
                            return true;
                        });
                    },

                    // 检查当前密钥列表中的重复项
                    checkCurrentKeyDuplicates() {
                        const duplicateIndexes = new Set();
                        const seen = new Map();
                        
                        this.groupFormData.api_keys.forEach((key, index) => {
                            const trimmedKey = key.trim();
                            if (trimmedKey.length === 0) return;
                            
                            if (seen.has(trimmedKey)) {
                                // 标记当前索引和之前的索引为重复
                                duplicateIndexes.add(index);
                                duplicateIndexes.add(seen.get(trimmedKey));
                            } else {
                                seen.set(trimmedKey, index);
                            }
                        });
                        
                        return duplicateIndexes;
                    },

                    // 移除所有重复的密钥，只保留第一个
                    removeDuplicateKeys() {
                        const originalLength = this.groupFormData.api_keys.length;
                        const validKeys = this.groupFormData.api_keys.filter(key => key.trim().length > 0);
                        const uniqueKeys = this.deduplicateKeys(validKeys);
                        
                        // 如果所有密钥都被去重了，至少保留一个空项
                        if (uniqueKeys.length === 0) {
                            this.groupFormData.api_keys = [""];
                        } else {
                            this.groupFormData.api_keys = uniqueKeys;
                        }
                        
                        const removedCount = originalLength - this.groupFormData.api_keys.length;
                        if (removedCount > 0) {
                            this.showMessage(`已移除 ${removedCount} 个重复密钥`, "success");
                        }
                        
                        // 重置页码和选中状态
                        this.selectedKeys = [];
                        this.keyPage = 1;
                    },

                    removeGroupApiKey(index) {
                        if (this.groupFormData.api_keys.length > 1) {
                            this.groupFormData.api_keys.splice(index, 1);
                            // 调整页码如果当前页没有数据了
                            if (
                                this.keyPageOffset >=
                                    this.groupFormData.api_keys.length &&
                                this.keyPage > 1
                            ) {
                                this.keyPage--;
                            }
                            // 清除选中状态
                            this.selectedKeys = this.selectedKeys.filter(
                                (i) => i < this.groupFormData.api_keys.length,
                            );
                        }
                    },

                    // 批量添加密钥
                    addBatchKeys() {
                        const keys = this.batchKeysText
                            .split("\n")
                            .map((line) => line.trim())
                            .filter((line) => line.length > 0);

                        if (keys.length > 0) {
                            // 获取现有的非空密钥
                            const existingKeys = this.groupFormData.api_keys
                                .map(key => key.trim())
                                .filter(key => key.length > 0);
                            
                            // 检查重复密钥
                            const duplicateKeys = [];
                            const newUniqueKeys = [];
                            
                            keys.forEach(key => {
                                if (existingKeys.includes(key)) {
                                    duplicateKeys.push(key);
                                } else if (!newUniqueKeys.includes(key)) {
                                    newUniqueKeys.push(key);
                                }
                            });
                            
                            // 添加新的唯一密钥
                            if (newUniqueKeys.length > 0) {
                                this.groupFormData.api_keys.push(...newUniqueKeys);
                            }
                            
                            this.batchKeysText = "";
                            this.showBatchAddModal = false;
                            
                            // 显示结果消息
                            let message = `成功添加 ${newUniqueKeys.length} 个密钥`;
                            if (duplicateKeys.length > 0) {
                                message += `，跳过 ${duplicateKeys.length} 个重复密钥`;
                            }
                            this.showMessage(message, "success");
                        }
                    },

                    // 删除选中的密钥
                    deleteSelectedKeys() {
                        if (this.selectedKeys.length === 0) return;

                        if (
                            !confirm(
                                `确定要删除选中的 ${this.selectedKeys.length} 个密钥吗？`,
                            )
                        ) {
                            return;
                        }

                        // 按索引倒序删除，避免索引变化问题
                        const sortedIndexes = [...this.selectedKeys].sort(
                            (a, b) => b - a,
                        );
                        sortedIndexes.forEach((index) => {
                            this.groupFormData.api_keys.splice(index, 1);
                        });

                        // 确保至少有一个空项
                        if (this.groupFormData.api_keys.length === 0) {
                            this.groupFormData.api_keys.push("");
                        }

                        // 清除选中状态
                        this.selectedKeys = [];

                        // 调整页码
                        if (
                            this.keyPageOffset >=
                                this.groupFormData.api_keys.length &&
                            this.keyPage > 1
                        ) {
                            this.keyPage--;
                        }

                        this.showMessage(
                            `成功删除 ${sortedIndexes.length} 个密钥`,
                            "success",
                        );
                    },

                    // 删除失效密钥
                    deleteInvalidKeys() {
                        // 找出所有失效的密钥索引
                        const invalidIndexes = [];
                        this.groupFormData.api_keys.forEach((key, index) => {
                            if (
                                key.trim() &&
                                this.keyValidationStatus[index] === "invalid"
                            ) {
                                invalidIndexes.push(index);
                            }
                        });

                        if (invalidIndexes.length === 0) {
                            this.showMessage("没有找到失效的密钥", "info");
                            return;
                        }

                        if (
                            !confirm(
                                `确定要删除 ${invalidIndexes.length} 个失效密钥吗？`,
                            )
                        ) {
                            return;
                        }

                        // 按索引倒序删除
                        const sortedIndexes = [...invalidIndexes].sort(
                            (a, b) => b - a,
                        );
                        sortedIndexes.forEach((index) => {
                            this.groupFormData.api_keys.splice(index, 1);
                        });

                        // 确保至少有一个空项
                        if (this.groupFormData.api_keys.length === 0) {
                            this.groupFormData.api_keys.push("");
                        }

                        // 重新构建验证状态，移除已删除密钥的状态
                        const newValidationStatus = {};
                        const newInvalidIndexes = [];
                        this.groupFormData.api_keys.forEach((key, newIndex) => {
                            // 找到原来的索引对应的状态
                            for (
                                let oldIndex = 0;
                                oldIndex <
                                this.groupFormData.api_keys.length +
                                    sortedIndexes.length;
                                oldIndex++
                            ) {
                                if (
                                    !sortedIndexes.includes(oldIndex) &&
                                    this.keyValidationStatus[oldIndex]
                                ) {
                                    const adjustedIndex =
                                        oldIndex -
                                        sortedIndexes.filter(
                                            (idx) => idx < oldIndex,
                                        ).length;
                                    if (adjustedIndex === newIndex) {
                                        newValidationStatus[newIndex] =
                                            this.keyValidationStatus[oldIndex];
                                        if (
                                            this.keyValidationStatus[
                                                oldIndex
                                            ] === "invalid"
                                        ) {
                                            newInvalidIndexes.push(newIndex);
                                        }
                                        break;
                                    }
                                }
                            }
                        });

                        this.keyValidationStatus = newValidationStatus;
                        this.invalidKeyIndexes = newInvalidIndexes;

                        // 调整页码
                        if (
                            this.keyPageOffset >=
                                this.groupFormData.api_keys.length &&
                            this.keyPage > 1
                        ) {
                            this.keyPage--;
                        }

                        this.showMessage(
                            `成功删除 ${sortedIndexes.length} 个失效密钥`,
                            "success",
                        );
                    },

                    // 验证密钥
                    async validateKeys() {
                        const validKeys = this.groupFormData.api_keys.filter(
                            (key) => key.trim().length > 0,
                        );
                        if (validKeys.length === 0) {
                            this.showMessage(
                                "请先添加至少一个API密钥",
                                "error",
                            );
                            return;
                        }

                        if (
                            !this.groupFormData.provider_type ||
                            !this.groupFormData.base_url
                        ) {
                            this.showMessage(
                                "请先填写提供商类型和Base URL",
                                "error",
                            );
                            return;
                        }

                        this.validatingKeys = true;
                        this.keyValidationStatus = {};
                        this.invalidKeyIndexes = [];

                        try {
                            // 标记所有密钥为验证中
                            this.groupFormData.api_keys.forEach(
                                (key, index) => {
                                    if (key.trim().length > 0) {
                                        this.keyValidationStatus[index] =
                                            "validating";
                                    }
                                },
                            );

                            // 创建临时分组配置来验证密钥
                            const tempGroupData = {
                                name: this.groupFormData.name || "temp",
                                provider_type: this.groupFormData.provider_type,
                                base_url: this.groupFormData.base_url,
                                enabled: true,
                                timeout: this.groupFormData.timeout || 30,
                                max_retries:
                                    this.groupFormData.max_retries || 3,
                                rotation_strategy:
                                    this.groupFormData.rotation_strategy ||
                                    "round_robin",
                                api_keys: validKeys,
                            };

                            const response = await fetch(
                                "/admin/keys/validate",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(tempGroupData),
                                },
                            );

                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.success && data.results) {
                                        let validCount = 0;
                                        let invalidCount = 0;
                                        let unknownCount = 0;

                                    // 更新验证状态
                                    data.results.forEach(
                                        (result, resultIndex) => {
                                            // 找到对应的原始索引
                                            let originalIndex = 0;
                                            let validKeyIndex = 0;
                                            for (
                                                let i = 0;
                                                i <
                                                this.groupFormData.api_keys
                                                    .length;
                                                i++
                                            ) {
                                                if (
                                                    this.groupFormData.api_keys[
                                                        i
                                                    ].trim().length > 0
                                                ) {
                                                    if (
                                                        validKeyIndex ===
                                                        resultIndex
                                                    ) {
                                                        originalIndex = i;
                                                        break;
                                                    }
                                                    validKeyIndex++;
                                                }
                                            }

                                            const status =
                                                result.status ||
                                                (result.valid
                                                    ? "valid"
                                                    : "invalid");

                                            if (status === "valid") {
                                                this.keyValidationStatus[
                                                    originalIndex
                                                ] = "valid";
                                                validCount++;
                                            } else if (status === "invalid") {
                                                this.keyValidationStatus[
                                                    originalIndex
                                                ] = "invalid";
                                                this.invalidKeyIndexes.push(
                                                    originalIndex,
                                                );
                                                invalidCount++;
                                            } else {
                                                this.keyValidationStatus[
                                                    originalIndex
                                                ] = "unknown";
                                                unknownCount++;
                                            }
                                        },
                                    );

                                    this.showMessage(
                                        `验证完成：${validCount} 个有效，${invalidCount} 个无效，${unknownCount} 个未知（可能限速/临时错误）`,
                                        validCount > 0 ? "success" : "error",
                                    );
                                } else {
                                    this.showMessage(
                                        "验证失败: " +
                                            (data.message || "未知错误"),
                                        "error",
                                    );
                                }
                            } else {
                                const errorData = await response.json();
                                this.showMessage(
                                    "验证失败: " +
                                        (errorData.message || "网络错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            this.showMessage(
                                "验证失败: " + error.message,
                                "error",
                            );
                        } finally {
                            this.validatingKeys = false;
                        }
                    },

                    // 清空所有密钥
                    clearAllKeys() {
                        if (this.groupFormData.api_keys.filter(k => k.trim()).length === 0) {
                            this.showMessage("没有密钥需要清空", "info");
                            return;
                        }

                        if (!confirm("确定要清空所有密钥吗？此操作不可恢复。")) {
                            return;
                        }

                        // 清空所有密钥，只保留一个空项
                        this.groupFormData.api_keys = [""];
                        
                        // 清除选中状态和验证状态
                        this.selectedKeys = [];
                        this.keyValidationStatus = {};
                        this.invalidKeyIndexes = [];
                        
                        // 重置页码
                        this.keyPage = 1;
                        
                        this.showMessage("已清空所有密钥", "success");
                    },

                    // 导出密钥
                    exportKeys() {
                        const validKeys = this.groupFormData.api_keys.filter(k => k.trim());
                        
                        if (validKeys.length === 0) {
                            this.showMessage("没有密钥可以导出", "info");
                            return;
                        }

                        try {
                            // 创建文件内容，每行一个密钥
                            const content = validKeys.join('\n');
                            
                            // 生成文件名
                            const groupName = this.groupFormData.name || this.groupFormData.group_id || 'group';
                            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                            const filename = `${groupName}_api_keys_${timestamp}.txt`;
                            
                            // 创建并下载文件
                            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            this.showMessage(`已导出 ${validKeys.length} 个密钥到文件 ${filename}`, "success");
                        } catch (error) {
                            console.error('导出密钥失败:', error);
                            this.showMessage("导出密钥失败: " + error.message, "error");
                        }
                    },

                    // 强制设置密钥状态
                    async forceSetKeyStatus(keyIndex, status) {
                        const apiKey = this.groupFormData.api_keys[keyIndex];
                        if (!apiKey || !apiKey.trim()) {
                            this.showMessage("密钥不能为空", "error");
                            return;
                        }

                        if (!this.editingGroupId) {
                            this.showMessage("只能在编辑模式下强制设置密钥状态", "error");
                            return;
                        }

                        // 设置加载状态
                        this.forcingKeyStatus[keyIndex] = true;
                        this.forcingKeyStatus = { ...this.forcingKeyStatus };

                        try {
                            const response = await fetch(
                                `/admin/groups/${this.editingGroupId}/keys/force-status`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        api_key: apiKey.trim(),
                                        is_valid: status === 'valid',
                                        force_set: true,
                                    }),
                                }
                            );

                            const result = await response.json();

                            if (response.ok && result.success) {
                                // 更新本地验证状态
                                this.keyValidationStatus[keyIndex] = status;
                                this.keyValidationStatus = { ...this.keyValidationStatus };

                                // 更新失效密钥索引列表
                                if (status === 'invalid') {
                                    if (!this.invalidKeyIndexes.includes(keyIndex)) {
                                        this.invalidKeyIndexes.push(keyIndex);
                                    }
                                } else {
                                    const invalidIndex = this.invalidKeyIndexes.indexOf(keyIndex);
                                    if (invalidIndex > -1) {
                                        this.invalidKeyIndexes.splice(invalidIndex, 1);
                                    }
                                }

                                // 刷新提供商状态列表以更新分组列表中的信息
                                await this.loadProviderStatuses();
                                
                                // 重新加载持久化验证状态以更新密钥状态统计
                                await this.loadPersistedValidationStatus(false);

                                this.showMessage(
                                    `密钥状态已强制设置为${status === 'valid' ? '有效' : '无效'}`,
                                    "success"
                                );
                            } else {
                                throw new Error(result.message || "设置密钥状态失败");
                            }
                        } catch (error) {
                            console.error("强制设置密钥状态失败:", error);
                            this.showMessage(
                                "强制设置密钥状态失败: " + error.message,
                                "error"
                            );
                        } finally {
                            // 清除加载状态
                            this.forcingKeyStatus[keyIndex] = false;
                            this.forcingKeyStatus = { ...this.forcingKeyStatus };
                        }
                    },

                    // 一键删除失效密钥（从服务器）
                    async bulkDeleteInvalidKeysFromServer() {
                        if (!this.editingGroupId) {
                            this.showMessage("只能在编辑模式下删除失效密钥", "error");
                            return;
                        }

                        // 检查本地是否有失效密钥
                        const localInvalidCount = this.getInvalidKeyCount();
                        
                        // 如果本地没有失效密钥，但分组列表显示有失效密钥，提示用户先检测
                        if (localInvalidCount === 0) {
                            const groupKeyStatus = this.keyStatus.groups && this.keyStatus.groups[this.editingGroupId];
                            if (groupKeyStatus && groupKeyStatus.invalid_keys > 0) {
                                this.showMessage(
                                    `检测到 ${groupKeyStatus.invalid_keys} 个失效密钥，但本地验证状态未加载。请先点击"验证密钥"按钮检测密钥状态，然后再执行删除操作。`,
                                    "error"
                                );
                                return;
                            } else {
                                this.showMessage("没有失效密钥需要删除", "info");
                                return;
                            }
                        }

                        if (!confirm(`确定要删除 ${localInvalidCount} 个失效密钥吗？此操作不可恢复。`)) {
                            return;
                        }

                        this.bulkDeletingInvalidKeys = true;

                        try {
                            const response = await fetch(
                                `/admin/groups/${this.editingGroupId}/keys/invalid`,
                                {
                                    method: "DELETE",
                                }
                            );

                            const result = await response.json();

                            if (response.ok && result.success) {
                                // 从本地数组中移除失效密钥
                                const validKeys = [];
                                this.groupFormData.api_keys.forEach((key, index) => {
                                    if (key.trim() && this.keyValidationStatus[index] !== 'invalid') {
                                        validKeys.push(key);
                                    } else if (!key.trim()) {
                                        // 保留空密钥项
                                        validKeys.push(key);
                                    }
                                });

                                // 如果所有密钥都被删除了，至少保留一个空项
                                if (validKeys.filter(k => k.trim()).length === 0) {
                                    validKeys.push("");
                                }

                                this.groupFormData.api_keys = validKeys;

                                // 重建验证状态
                                const newValidationStatus = {};
                                const newInvalidIndexes = [];
                                this.groupFormData.api_keys.forEach((key, newIndex) => {
                                    // 只保留有效密钥的状态
                                    if (key.trim()) {
                                        newValidationStatus[newIndex] = 'valid'; // 假设剩余的都是有效的
                                    }
                                });

                                this.keyValidationStatus = newValidationStatus;
                                this.invalidKeyIndexes = newInvalidIndexes;

                                // 重置页码和选中状态
                                this.selectedKeys = [];
                                this.keyPage = 1;

                                // 刷新提供商状态列表以更新分组列表中的信息
                                await this.loadProviderStatuses();
                                
                                // 重新加载持久化验证状态以更新密钥状态统计
                                await this.loadPersistedValidationStatus(false);

                                this.showMessage(
                                    `成功删除 ${result.deleted_count} 个失效密钥`,
                                    "success"
                                );
                            } else {
                                throw new Error(result.message || "删除失效密钥失败");
                            }
                        } catch (error) {
                            console.error("一键删除失效密钥失败:", error);
                            this.showMessage(
                                "一键删除失效密钥失败: " + error.message,
                                "error"
                            );
                        } finally {
                            this.bulkDeletingInvalidKeys = false;
                        }
                    },

                    // 获取API密钥验证状态
                    async loadKeyValidationStatus(groupId) {
                        if (!groupId) return;

                        try {
                            const response = await fetch(
                                `/admin/keys/validation/${groupId}`,
                            );
                            if (response.ok) {
                                const data = await response.json();
                                if (data.success && data.validation_status) {
                                    // 更新密钥验证状态
                                    this.keyValidationStatus = {};
                                    this.invalidKeyIndexes = [];
                                    this.groupFormData.api_keys.forEach(
                                        (key, index) => {
                                            if (
                                                key.trim() &&
                                                data.validation_status[
                                                    key.trim()
                                                ]
                                            ) {
                                                const status =
                                                    data.validation_status[
                                                        key.trim()
                                                    ];
                                                if (status.is_valid === true) {
                                                    this.keyValidationStatus[
                                                        index
                                                    ] = "valid";
                                                } else if (
                                                    status.is_valid === false
                                                ) {
                                                    this.keyValidationStatus[
                                                        index
                                                    ] = "invalid";
                                                    this.invalidKeyIndexes.push(
                                                        index,
                                                    );
                                                }
                                            }
                                        },
                                    );
                                }
                            }
                        } catch (error) {
                            console.error(
                                "Failed to load key validation status:",
                                error,
                            );
                        }
                    },

                    // 获取密钥验证样式类
                    getKeyValidationClass(index) {
                        const status = this.keyValidationStatus[index];
                        if (status === "valid") {
                            return "bg-green-50 border-green-200";
                        } else if (status === "invalid") {
                            return "bg-red-50 border-red-200";
                        } else if (status === "validating") {
                            return "bg-yellow-50 border-yellow-200";
                        } else if (status === "unknown") {
                            return "bg-gray-50 border-gray-200";
                        }
                        return "";
                    },

                    // 获取失效密钥数量
                    getInvalidKeyCount() {
                        let count = 0;
                        this.groupFormData.api_keys.forEach((key, index) => {
                            if (
                                key.trim() &&
                                this.keyValidationStatus[index] === "invalid"
                            ) {
                                count++;
                            }
                        });
                        return count;
                    },

                    // 加载可用模型
                    async loadAvailableModels(forceRefresh = false) {
                        this.modelLoadError = null;

                        // 如果是编辑模式，可以直接从现有分组加载模型
                        if (this.showEditGroupModal && this.editingGroupId) {
                            this.loadingModels = true;
                            try {
                                const url = forceRefresh
                                    ? `/admin/models/available/${this.editingGroupId}?refresh=true`
                                    : `/admin/models/available/${this.editingGroupId}`;

                                const response = await fetch(url);

                                if (response.ok) {
                                    const data = await response.json();
                                    // 解析响应数据
                                    const groupData =
                                        data.data[this.editingGroupId];
                                    if (
                                        groupData &&
                                        groupData.models &&
                                        groupData.models.data
                                    ) {
                                        this.availableModels =
                                            groupData.models.data;
                                        this.modelCacheTimestamp = new Date();
                                        this.filterModels();
                                        this.showMessage(
                                            `成功加载 ${this.availableModels.length} 个模型${forceRefresh ? '（已刷新缓存）' : ''}`,
                                            "success",
                                        );
                                    } else {
                                        this.availableModels = [];
                                        this.filterModels();
                                        this.modelLoadError = "未找到可用模型";
                                        this.showMessage(
                                            "未找到可用模型",
                                            "error",
                                        );
                                    }
                                } else {
                                    const errorData = await response.json();
                                    this.modelLoadError = errorData.error?.message || "加载失败";
                                    this.showMessage(
                                        "加载模型失败: " + this.modelLoadError,
                                        "error",
                                    );
                                }
                            } catch (error) {
                                this.modelLoadError = error.message;
                                this.showMessage(
                                    "网络错误: " + error.message,
                                    "error",
                                );
                            } finally {
                                this.loadingModels = false;
                            }
                            return;
                        }

                        // 创建模式需要先验证配置
                        if (
                            !this.groupFormData.provider_type ||
                            !this.groupFormData.base_url
                        ) {
                            this.showMessage(
                                "请先填写提供商类型和Base URL",
                                "error",
                            );
                            return;
                        }

                        const validKeys = this.groupFormData.api_keys.filter(
                            (key) => key.trim().length > 0,
                        );
                        if (validKeys.length === 0) {
                            this.showMessage(
                                "请先添加至少一个API密钥",
                                "error",
                            );
                            return;
                        }

                        this.loadingModels = true;
                        try {
                            // 创建临时分组配置来测试模型加载
                            const tempGroupData = {
                                name: this.groupFormData.name || "temp",
                                provider_type: this.groupFormData.provider_type,
                                base_url: this.groupFormData.base_url,
                                enabled: true,
                                timeout: this.groupFormData.timeout || 30,
                                max_retries:
                                    this.groupFormData.max_retries || 3,
                                rotation_strategy:
                                    this.groupFormData.rotation_strategy ||
                                    "round_robin",
                                api_keys: validKeys,
                            };

                            // 使用新的按类型加载模型API
                            const response = await fetch(
                                "/admin/models/available/by-type",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({
                                        provider_type:
                                            tempGroupData.provider_type,
                                        base_url: tempGroupData.base_url,
                                        api_keys: tempGroupData.api_keys,
                                        timeout_seconds: tempGroupData.timeout,
                                        max_retries: tempGroupData.max_retries,
                                        headers:
                                            this.groupFormData.headers || {},
                                    }),
                                },
                            );

                            if (response.ok) {
                                const data = await response.json();
                                // 解析新API的响应格式
                                const groupData = data.data["temp-group"];
                                if (
                                    groupData &&
                                    groupData.models &&
                                    groupData.models.data
                                ) {
                                    this.availableModels =
                                        groupData.models.data;
                                    this.modelCacheTimestamp = new Date();
                                    this.filterModels();
                                    this.showMessage(
                                        `成功加载 ${this.availableModels.length} 个模型${forceRefresh ? '（已刷新缓存）' : ''}`,
                                        "success",
                                    );
                                } else {
                                    this.availableModels = [];
                                    this.filterModels();
                                    this.modelLoadError = "未找到可用模型";
                                    this.showMessage("未找到可用模型", "error");
                                }
                            } else {
                                const errorData = await response.json();
                                this.modelLoadError = errorData.error || errorData.suggestion || "加载失败";
                                this.showMessage(
                                    "加载模型失败: " + (errorData.error || "未知错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            this.modelLoadError = error.message;
                            this.showMessage(
                                "网络错误: " + error.message,
                                "error",
                            );
                        } finally {
                            this.loadingModels = false;
                        }
                    },

                    // 筛选模型
                    filterModels() {
                        let filtered = this.availableModels;

                        // Apply capability filter
                        if (this.modelCapabilityFilter !== 'all') {
                            filtered = filtered.filter(model =>
                                model.capabilities &&
                                model.capabilities.includes(this.modelCapabilityFilter)
                            );
                        }

                        // Apply search query
                        if (this.modelSearchQuery.trim()) {
                            const query = this.modelSearchQuery.toLowerCase();
                            filtered = filtered.filter(model =>
                                model.id.toLowerCase().includes(query) ||
                                (model.display_name && model.display_name.toLowerCase().includes(query)) ||
                                (model.owned_by && model.owned_by.toLowerCase().includes(query)) ||
                                (model.description && model.description.toLowerCase().includes(query))
                            );
                        }

                        this.filteredModels = filtered;
                    },

                    // Refresh models (bypass cache)
                    async refreshModels() {
                        this.refreshingModels = true;
                        try {
                            await this.loadAvailableModels(true);
                        } finally {
                            this.refreshingModels = false;
                        }
                    },

                    // Filter by capability
                    filterByCapability(capability) {
                        this.modelCapabilityFilter = capability;
                        this.filterModels();
                    },

                    // Format context window
                    formatContextWindow(tokens) {
                        if (!tokens) return '';
                        if (tokens >= 1000000) {
                            return `${(tokens / 1000000).toFixed(1)}M tokens`;
                        } else if (tokens >= 1000) {
                            return `${(tokens / 1000).toFixed(0)}K tokens`;
                        }
                        return `${tokens} tokens`;
                    },

                    // Sort selected models
                    sortSelectedModels() {
                        this.groupFormData.models = [...this.groupFormData.models].sort();
                    },

                    // 清除模型搜索
                    clearModelSearch() {
                        this.modelSearchQuery = "";
                        this.filterModels();
                    },

                    // 全选模型
                    selectAllModels() {
                        this.groupFormData.models = this.filteredModels.map(
                            (model) => model.id,
                        );
                    },

                    // 清空模型选择
                    clearAllModels() {
                        this.groupFormData.models = [];
                    },

                    // 移除单个模型
                    removeModel(modelId) {
                        this.groupFormData.models =
                            this.groupFormData.models.filter(
                                (id) => id !== modelId,
                            );
                    },

                    // 验证JSON请求参数格式
                    validateRequestParams() {
                        if (!this.requestParamsText.trim()) {
                            this.requestParamsValidationMessage = "";
                            this.requestParamsValidationError = false;
                            return;
                        }

                        try {
                            const parsed = JSON.parse(
                                this.requestParamsText.trim(),
                            );

                            // 检查是否是对象
                            if (
                                typeof parsed !== "object" ||
                                Array.isArray(parsed) ||
                                parsed === null
                            ) {
                                this.requestParamsValidationMessage =
                                    "JSON必须是一个对象";
                                this.requestParamsValidationError = true;
                                return;
                            }

                            // 检查是否为空对象
                            if (Object.keys(parsed).length === 0) {
                                this.requestParamsValidationMessage =
                                    "JSON对象不能为空";
                                this.requestParamsValidationError = true;
                                return;
                            }

                            // 提供一些常见参数的友好提示（可选验证）
                            const warnings = [];

                            if ("temperature" in parsed && typeof parsed.temperature === "number") {
                                if (parsed.temperature < 0 || parsed.temperature > 2) {
                                    warnings.push("temperature通常在0-2之间");
                                }
                            }

                            if ("top_p" in parsed && typeof parsed.top_p === "number") {
                                if (parsed.top_p < 0 || parsed.top_p > 1) {
                                    warnings.push("top_p通常在0-1之间");
                                }
                            }

                            if ("max_tokens" in parsed && typeof parsed.max_tokens === "number") {
                                if (parsed.max_tokens <= 0) {
                                    warnings.push("max_tokens应该是正数");
                                }
                            }

                            // 显示成功消息和可选警告
                            const paramCount = Object.keys(parsed).length;
                            let message = `✓ JSON格式正确，包含 ${paramCount} 个参数`;

                            if (warnings.length > 0) {
                                message += ` (提示: ${warnings.join(", ")})`;
                            }

                            this.requestParamsValidationMessage = message;
                            this.requestParamsValidationError = false;
                        } catch (e) {
                            this.requestParamsValidationMessage =
                                "JSON格式错误: " + e.message;
                            this.requestParamsValidationError = true;
                        }
                    },

                    // 添加模型映射
                    addModelMapping() {
                        this.modelMappings.push({ alias: "", original: "" });
                    },

                    // 移除模型映射
                    removeModelMapping(index) {
                        this.modelMappings.splice(index, 1);
                    },

                    // 添加Header
                    addHeader() {
                        this.headers.push({ key: "", value: "" });
                        this.syncHeadersToGroupForm();
                    },

                    // 移除Header
                    removeHeader(index) {
                        this.headers.splice(index, 1);
                        this.syncHeadersToGroupForm();
                    },

                    // 同步headers到groupFormData
                    syncHeadersToGroupForm() {
                        const headersMap = {};
                        this.headers.forEach(header => {
                            if (header.key && header.key.trim() && header.value && header.value.trim()) {
                                headersMap[header.key.trim()] = header.value.trim();
                            }
                        });
                        this.groupFormData.headers = headersMap;
                    },

                    // 加载分组数据时解析headers
                    loadHeadersFromGroup(groupData) {
                        this.headers = [];
                        if (groupData.headers && typeof groupData.headers === 'object') {
                            Object.entries(groupData.headers).forEach(([key, value]) => {
                                this.headers.push({ key: key, value: value });
                            });
                        }
                        if (this.headers.length === 0) {
                            this.headers.push({ key: "", value: "" });
                        }
                        this.syncHeadersToGroupForm();
                    },

                    // 验证Headers JSON格式
                    validateHeadersJson() {
                        const text = this.headersJsonText.trim();
                        if (!text) {
                            this.headersJsonValidationMessage = "";
                            this.headersJsonValidationError = false;
                            return;
                        }

                        try {
                            const parsed = JSON.parse(text);
                            if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
                                this.headersJsonValidationMessage = "JSON必须是对象格式，如 {\"key\": \"value\"}";
                                this.headersJsonValidationError = true;
                                return;
                            }

                            // 检查所有值都是字符串
                            const nonStringValues = Object.entries(parsed).filter(([key, value]) => typeof value !== 'string');
                            if (nonStringValues.length > 0) {
                                this.headersJsonValidationMessage = "所有header值都必须是字符串格式";
                                this.headersJsonValidationError = true;
                                return;
                            }

                            const keyCount = Object.keys(parsed).length;
                            this.headersJsonValidationMessage = `JSON格式正确，包含 ${keyCount} 个header`;
                            this.headersJsonValidationError = false;
                        } catch (e) {
                            this.headersJsonValidationMessage = "JSON格式错误: " + e.message;
                            this.headersJsonValidationError = true;
                        }
                    },

                    // 解析并导入Headers JSON
                    parseHeadersJson() {
                        if (!this.headersJsonText.trim() || this.headersJsonValidationError) {
                            return;
                        }

                        try {
                            const parsed = JSON.parse(this.headersJsonText);
                            if (typeof parsed !== 'object' || parsed === null) {
                                throw new Error("JSON必须是对象格式");
                            }

                            // 清空现有headers并导入新的
                            this.headers = [];
                            Object.entries(parsed).forEach(([key, value]) => {
                                if (key && key.trim() && value && value.toString().trim()) {
                                    this.headers.push({
                                        key: key.trim(),
                                        value: value.toString().trim()
                                    });
                                }
                            });

                            // 如果没有有效的headers，至少保留一个空行
                            if (this.headers.length === 0) {
                                this.headers.push({ key: "", value: "" });
                            }

                            this.syncHeadersToGroupForm();
                            this.headersJsonValidationMessage = `成功导入 ${this.headers.length} 个headers`;
                            this.headersJsonValidationError = false;
                        } catch (e) {
                            this.headersJsonValidationMessage = "导入失败: " + e.message;
                            this.headersJsonValidationError = true;
                        }
                    },

                    // 清空所有headers
                    clearAllHeaders() {
                        if (confirm("确定要清空所有headers吗？此操作不可恢复。")) {
                            this.headers = [{ key: "", value: "" }];
                            this.headersJsonText = "";
                            this.headersJsonValidationMessage = "";
                            this.headersJsonValidationError = false;
                            this.syncHeadersToGroupForm();
                        }
                    },

                    // 检查是否是重复的别名
                    isDuplicateAlias(alias, currentIndex) {
                        if (!alias || !alias.trim()) {
                            return false;
                        }

                        const trimmedAlias = alias.trim();
                        let count = 0;

                        for (let i = 0; i < this.modelMappings.length; i++) {
                            if (this.modelMappings[i].alias &&
                                this.modelMappings[i].alias.trim() === trimmedAlias) {
                                count++;
                                if (count > 1 && i !== currentIndex) {
                                    return true;
                                }
                            }
                        }

                        return false;
                    },

                    // 获取重复别名的CSS类
                    getDuplicateAliasClass(alias, currentIndex) {
                        const baseClass = "w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1";

                        if (this.isDuplicateAlias(alias, currentIndex)) {
                            return baseClass + " border-orange-300 focus:ring-orange-500 bg-orange-50";
                        } else {
                            return baseClass + " border-gray-300 focus:ring-blue-500";
                        }
                    },

                    showMessage(msg, type = "success") {
                        this.message = msg;
                        this.messageType = type;
                        setTimeout(() => {
                            this.message = "";
                        }, 3000);
                    },

                    getKeyStatusText(groupId, provider) {
                        const keyStatusData = this.keyStatus.groups[groupId];
                        if (keyStatusData) {
                            return `${keyStatusData.valid_keys}/${keyStatusData.total_keys}`;
                        }
                        return `${provider.active_keys}/${provider.total_keys}`;
                    },

                    // 获取详细的密钥状态数据
                    getKeyStatusData(groupId, provider) {
                        const keyStatusData =
                            this.keyStatus.groups &&
                            this.keyStatus.groups[groupId];

                        if (keyStatusData) {
                            // 如果有检测数据，使用检测结果
                            const valid = keyStatusData.valid_keys || 0;
                            const invalid = keyStatusData.invalid_keys || 0;
                            const total = keyStatusData.total_keys || 0;
                            const unknown =
                                keyStatusData.unknown_keys != null
                                    ? keyStatusData.unknown_keys || 0
                                    : Math.max(total - valid - invalid, 0);

                            return {
                                total: total,
                                valid: valid,
                                invalid: invalid,
                                unknown: unknown,
                            };
                        } else {
                            // 如果没有检测数据，使用提供商基本信息
                            const total = provider.total_keys || 0;
                            const active = provider.active_keys || 0;

                            return {
                                total: total,
                                valid: 0,
                                invalid: 0,
                                unknown: total, // 所有密钥都是未检测状态
                            };
                        }
                    },

                    // 移除自动刷新相关方法
                    // startAutoRefresh() {
                    //     this.stopAutoRefresh();
                    //     this.refreshTimer = setInterval(() => {
                    //         this.refreshData();
                    //     }, this.refreshInterval);
                    // },

                    // stopAutoRefresh() {
                    //     if (this.refreshTimer) {
                    //         clearInterval(this.refreshTimer);
                    //         this.refreshTimer = null;
                    //     }
                    // },

                    // updateRefreshInterval() {
                    //     if (this.autoRefresh) {
                    //         this.startAutoRefresh();
                    //     }
                    // },

                    getStatusText(status) {
                        const statusMap = {
                            healthy: "健康",
                            degraded: "降级",
                            unhealthy: "异常",
                        };
                        return statusMap[status] || "未知";
                    },

                    getProviderTypeClass(type) {
                        const typeClasses = {
                            openai: "bg-blue-100 text-blue-800",
                            gemini: "bg-green-100 text-green-800",
                            anthropic: "bg-purple-100 text-purple-800",
                            azure_openai: "bg-cyan-100 text-cyan-800",
                        };
                        return typeClasses[type] || "bg-gray-100 text-gray-800";
                    },

                    formatDuration(nanoseconds) {
                        if (!nanoseconds) return "--";
                        const seconds = Math.floor(nanoseconds / 1000000000);
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        return `${hours}h ${minutes}m`;
                    },

                    formatResponseTime(nanoseconds) {
                        if (!nanoseconds) return "--";
                        const ms = Math.floor(nanoseconds / 1000000);
                        return `${ms}ms`;
                    },

                    formatDate(dateStr) {
                        if (!dateStr) return "--";
                        return new Date(dateStr).toLocaleString("zh-CN");
                    },

                    formatPercentage(value) {
                        if (value === null || value === undefined) return "0%";
                        return parseFloat(value).toFixed(2) + "%";
                    },

                    // 启动系统健康状态的定时刷新（只刷新第一排系统信息）
                    startSystemHealthRefresh() {
                        // 立即执行一次刷新
                        this.refreshSystemHealthOnly();

                        // 设置定时器，每60秒刷新一次系统健康状态
                        setInterval(() => {
                            this.refreshSystemHealthOnly();
                        }, 60000); // 60秒刷新一次
                    },

                    // 只刷新系统健康状态（第一排的系统信息）
                    async refreshSystemHealthOnly() {
                        try {
                            await this.loadSystemHealth();
                            this.lastUpdate = new Date();
                        } catch (error) {
                            console.error(
                                "Failed to refresh system health:",
                                error,
                            );
                        }
                    },

                    // 刷新所有数据（手动刷新时使用）
                    async refreshSystemData() {
                        try {
                            await Promise.all([
                                this.loadSystemHealth(),
                                this.loadProviderStatuses(),
                            ]);
                            this.lastUpdate = new Date();
                        } catch (error) {
                            console.error(
                                "Failed to refresh system data:",
                                error,
                            );
                        }
                    },

                    // 刷新代理密钥使用次数（静默刷新，不显示加载状态）
                    async refreshProxyKeysOnly() {
                        try {
                            // 如果代理密钥模态框打开，则刷新数据
                            if (this.showProxyKeyModal) {
                                await this.loadProxyKeys();
                            }
                        } catch (error) {
                            console.error(
                                "Failed to refresh proxy keys:",
                                error,
                            );
                        }
                    },

                    // 手动刷新所有分组的健康检查
                    async refreshAllHealth() {
                        this.loadingHealthRefresh = true;
                        try {
                            const response = await fetch(
                                "/admin/health/refresh",
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                },
                            );

                            const result = await response.json();

                            if (response.ok) {
                                this.showMessage(
                                    "健康检查已启动，请稍等片刻后查看结果",
                                    "success",
                                );
                                // 延迟一段时间后刷新数据以显示检查结果
                                setTimeout(async () => {
                                    await this.loadProviderStatuses();
                                }, 3000);
                            } else {
                                throw new Error(
                                    result.error || "刷新健康检查失败",
                                );
                            }
                        } catch (error) {
                            console.error("刷新健康检查失败:", error);
                            this.showMessage(
                                "刷新健康检查失败: " + error.message,
                                "error",
                            );
                        } finally {
                            this.loadingHealthRefresh = false;
                        }
                    },

                    // 代理密钥管理方法
                    async loadProxyKeys(page = null, search = null, sortBy = null) {
                        try {
                            // 使用传入的参数或当前状态
                            const currentPage =
                                page !== null ? page : this.proxyKeyPage;
                            const currentSearch =
                                search !== null ? search : this.proxyKeySearch;
                            const currentSortBy =
                                sortBy !== null ? sortBy : this.proxyKeySortBy;

                            // 构建查询参数
                            const params = new URLSearchParams({
                                page: currentPage.toString(),
                                page_size: this.proxyKeyPageSize.toString(),
                                sort_by: currentSortBy,
                            });

                            if (currentSearch.trim()) {
                                params.append("search", currentSearch.trim());
                            }

                            const response = await fetch(
                                `/admin/proxy-keys?${params}`,
                            );
                            const result = await response.json();

                            if (result.success) {
                                this.proxyKeys = result.keys || [];
                                this.proxyKeyPagination =
                                    result.pagination || {};
                                this.proxyKeyPage =
                                    this.proxyKeyPagination.page || 1;
                                // 更新当前排序状态
                                if (result.sort_by) {
                                    this.proxyKeySortBy = result.sort_by;
                                }
                            } else {
                                console.error("加载代理密钥失败:", result);
                            }
                        } catch (error) {
                            console.error("加载代理密钥失败:", error);
                        }
                    },

                    async generateProxyKey() {
                        if (!this.newProxyKey.name.trim()) {
                            this.showMessage("请输入密钥名称", "error");
                            return;
                        }

                        try {
                            // 准备请求数据
                            const requestData = {
                                name: this.newProxyKey.name,
                                description: this.newProxyKey.description,
                                allowedGroups: this.newProxyKey.allowedGroups,
                            };

                            // 如果有多个分组或空分组（访问所有分组），添加分组选择配置
                            if (
                                this.newProxyKey.allowedGroups.length > 1 ||
                                this.newProxyKey.allowedGroups.length === 0
                            ) {
                                requestData.groupSelectionConfig =
                                    this.newProxyKey.groupSelectionConfig;
                            }

                            const response = await fetch("/admin/proxy-keys", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify(requestData),
                            });

                            const result = await response.json();

                            if (result.success) {
                                this.showMessage(
                                    "代理密钥生成成功！",
                                    "success",
                                );
                                this.showGenerateProxyKeyForm = false;
                                this.resetProxyKeyForm();
                                await this.loadProxyKeys();
                            } else {
                                this.showMessage(
                                    "生成失败: " + (result.error || "未知错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            console.error("生成代理密钥失败:", error);
                            this.showMessage("网络错误，请检查连接", "error");
                        }
                    },

                    async deleteProxyKey(keyId) {
                        if (
                            !confirm(
                                "确定要删除这个代理密钥吗？删除后无法恢复。",
                            )
                        ) {
                            return;
                        }

                        try {
                            const response = await fetch(
                                `/admin/proxy-keys/${keyId}`,
                                {
                                    method: "DELETE",
                                },
                            );

                            const result = await response.json();
                            if (result.success) {
                                this.showMessage(
                                    "代理密钥删除成功！",
                                    "success",
                                );
                                await this.loadProxyKeys();
                            } else {
                                this.showMessage(
                                    "删除失败: " + (result.error || "未知错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            console.error("删除代理密钥失败:", error);
                            this.showMessage("网络错误，请检查连接", "error");
                        }
                    },

                    resetProxyKeyForm() {
                        this.newProxyKey = {
                            name: "",
                            description: "",
                            allowedGroups: [],
                            groupSelectionConfig: {
                                strategy: "round_robin",
                                groupWeights: [],
                            },
                        };
                    },

                    toggleProxyKeyGroup(groupId, checked) {
                        if (checked) {
                            if (
                                !this.newProxyKey.allowedGroups.includes(
                                    groupId,
                                )
                            ) {
                                this.newProxyKey.allowedGroups.push(groupId);
                            }
                        } else {
                            const index =
                                this.newProxyKey.allowedGroups.indexOf(groupId);
                            if (index > -1) {
                                this.newProxyKey.allowedGroups.splice(index, 1);
                            }
                        }
                    },

                    getGroupName(groupId) {
                        const provider = this.providerStatuses[groupId];
                        return provider ? provider.group_name : groupId;
                    },

                    // 编辑代理密钥相关方法
                    editProxyKey(key) {
                        this.editingProxyKey = {
                            id: key.id,
                            name: key.name,
                            description: key.description || "",
                            is_active: key.is_active !== false, // 默认为true
                            allowedGroups: key.allowed_groups
                                ? [...key.allowed_groups]
                                : [],
                            groupSelectionConfig: key.group_selection_config
                                ? {
                                      strategy:
                                          key.group_selection_config.strategy ||
                                          "round_robin",
                                      groupWeights: key.group_selection_config
                                          .group_weights
                                          ? [
                                                ...key.group_selection_config
                                                    .group_weights,
                                            ]
                                          : [],
                                  }
                                : {
                                      strategy: "round_robin",
                                      groupWeights: [],
                                  },
                        };
                        this.showEditProxyKeyModal = true;
                    },

                    closeEditProxyKeyModal() {
                        this.showEditProxyKeyModal = false;
                        this.editingProxyKey = {
                            id: "",
                            name: "",
                            description: "",
                            is_active: true,
                            allowedGroups: [],
                            groupSelectionConfig: {
                                strategy: "round_robin",
                                groupWeights: [],
                            },
                        };
                    },

                    toggleEditingProxyKeyGroup(groupId, checked) {
                        if (checked) {
                            if (
                                !this.editingProxyKey.allowedGroups.includes(
                                    groupId,
                                )
                            ) {
                                this.editingProxyKey.allowedGroups.push(
                                    groupId,
                                );
                            }
                        } else {
                            const index =
                                this.editingProxyKey.allowedGroups.indexOf(
                                    groupId,
                                );
                            if (index > -1) {
                                this.editingProxyKey.allowedGroups.splice(
                                    index,
                                    1,
                                );
                            }
                        }
                    },

                    async updateProxyKey() {
                        if (!this.editingProxyKey.name.trim()) {
                            this.showMessage("请输入密钥名称", "error");
                            return;
                        }

                        try {
                            // 准备请求数据
                            const requestData = {
                                name: this.editingProxyKey.name,
                                description: this.editingProxyKey.description,
                                is_active: this.editingProxyKey.is_active,
                                allowedGroups:
                                    this.editingProxyKey.allowedGroups,
                            };

                            // 如果有多个分组或空分组（访问所有分组），添加分组选择配置
                            if (
                                this.editingProxyKey.allowedGroups.length > 1 ||
                                this.editingProxyKey.allowedGroups.length === 0
                            ) {
                                requestData.groupSelectionConfig =
                                    this.editingProxyKey.groupSelectionConfig;
                            }

                            const response = await fetch(
                                `/admin/proxy-keys/${this.editingProxyKey.id}`,
                                {
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify(requestData),
                                },
                            );

                            const result = await response.json();

                            if (result.success) {
                                this.showMessage(
                                    "代理密钥更新成功！",
                                    "success",
                                );
                                this.closeEditProxyKeyModal();
                                await this.loadProxyKeys();
                            } else {
                                this.showMessage(
                                    "更新失败: " + (result.error || "未知错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            console.error("更新代理密钥失败:", error);
                            this.showMessage("网络错误，请检查连接", "error");
                        }
                    },

                    copyToClipboard(text) {
                        navigator.clipboard
                            .writeText(text)
                            .then(() => {
                                this.showMessage("已复制到剪贴板", "success");
                            })
                            .catch(() => {
                                // 降级方案
                                const textArea =
                                    document.createElement("textarea");
                                textArea.value = text;
                                document.body.appendChild(textArea);
                                textArea.select();
                                document.execCommand("copy");
                                document.body.removeChild(textArea);
                                this.showMessage("已复制到剪贴板", "success");
                            });
                    },

                    // 代理密钥搜索和分页方法
                    async searchProxyKeys() {
                        this.proxyKeyPage = 1; // 搜索时重置到第一页
                        await this.loadProxyKeys(1, this.proxyKeySearch);
                    },

                    // 更改代理密钥排序方式
                    async changeProxyKeySortBy() {
                        this.proxyKeyPage = 1; // 重置到第一页
                        await this.loadProxyKeys();
                    },

                    async goToProxyKeyPage(page) {
                        if (
                            page >= 1 &&
                            page <= this.proxyKeyPagination.total_pages
                        ) {
                            await this.loadProxyKeys(page);
                        }
                    },

                    async changeProxyKeyPageSize() {
                        this.proxyKeyPage = 1; // 改变页面大小时重置到第一页
                        await this.loadProxyKeys(1);
                    },

                    clearProxyKeySearch() {
                        this.proxyKeySearch = "";
                        this.searchProxyKeys();
                    },

                    viewProviderDetails(groupId) {
                        // 实现查看提供商详情的逻辑
                        alert(`查看提供商 ${groupId} 的详细信息`);
                    },

                    exportHealthReport() {
                        // 实现导出健康报告的逻辑
                        const report = {
                            timestamp: new Date().toISOString(),
                            system_health: this.systemHealth,
                            provider_statuses: this.providerStatuses,
                        };

                        const blob = new Blob(
                            [JSON.stringify(report, null, 2)],
                            { type: "application/json" },
                        );
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `health_report_${new Date().toISOString().split("T")[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    },

                    // 分组选择配置相关方法
                    getGroupsForWeightConfig(allowedGroups) {
                        // 如果没有选择任何分组，返回所有启用的分组
                        if (allowedGroups.length === 0) {
                            return Object.keys(this.providerStatuses).filter(
                                (groupId) =>
                                    this.providerStatuses[groupId] &&
                                    this.providerStatuses[groupId].enabled,
                            );
                        }
                        // 否则返回选择的分组
                        return allowedGroups;
                    },

                    onNewProxyKeyStrategyChange() {
                        if (
                            this.newProxyKey.groupSelectionConfig.strategy ===
                            "weighted"
                        ) {
                            // 为每个允许的分组初始化权重
                            const groups = this.getGroupsForWeightConfig(
                                this.newProxyKey.allowedGroups,
                            );
                            this.newProxyKey.groupSelectionConfig.groupWeights =
                                groups.map((groupId) => ({
                                    group_id: groupId,
                                    weight: 1,
                                }));
                        } else {
                            this.newProxyKey.groupSelectionConfig.groupWeights =
                                [];
                        }
                    },

                    onEditingProxyKeyStrategyChange() {
                        if (
                            this.editingProxyKey.groupSelectionConfig
                                .strategy === "weighted"
                        ) {
                            // 为每个允许的分组初始化权重
                            const groups = this.getGroupsForWeightConfig(
                                this.editingProxyKey.allowedGroups,
                            );
                            this.editingProxyKey.groupSelectionConfig.groupWeights =
                                groups.map((groupId) => ({
                                    group_id: groupId,
                                    weight:
                                        this.getEditingGroupWeight(groupId) ||
                                        1,
                                }));
                        } else {
                            this.editingProxyKey.groupSelectionConfig.groupWeights =
                                [];
                        }
                    },

                    getGroupWeight(groupId) {
                        const weight =
                            this.newProxyKey.groupSelectionConfig.groupWeights.find(
                                (w) => w.group_id === groupId,
                            );
                        return weight ? weight.weight : 1;
                    },

                    setGroupWeight(groupId, weight) {
                        const weightObj =
                            this.newProxyKey.groupSelectionConfig.groupWeights.find(
                                (w) => w.group_id === groupId,
                            );
                        if (weightObj) {
                            weightObj.weight = parseInt(weight) || 1;
                        } else {
                            this.newProxyKey.groupSelectionConfig.groupWeights.push(
                                {
                                    group_id: groupId,
                                    weight: parseInt(weight) || 1,
                                },
                            );
                        }
                    },

                    getEditingGroupWeight(groupId) {
                        const weight =
                            this.editingProxyKey.groupSelectionConfig.groupWeights.find(
                                (w) => w.group_id === groupId,
                            );
                        return weight ? weight.weight : 1;
                    },

                    setEditingGroupWeight(groupId, weight) {
                        const weightObj =
                            this.editingProxyKey.groupSelectionConfig.groupWeights.find(
                                (w) => w.group_id === groupId,
                            );
                        if (weightObj) {
                            weightObj.weight = parseInt(weight) || 1;
                        } else {
                            this.editingProxyKey.groupSelectionConfig.groupWeights.push(
                                {
                                    group_id: groupId,
                                    weight: parseInt(weight) || 1,
                                },
                            );
                        }
                    },

                    getStrategyDisplayName(strategy) {
                        const names = {
                            round_robin: "轮询",
                            weighted: "权重",
                            random: "随机",
                            failover: "故障转移",
                        };
                        return names[strategy] || strategy;
                    },

                    getStrategyBadgeClass(strategy) {
                        const classes = {
                            round_robin: "bg-blue-100 text-blue-800",
                            weighted: "bg-purple-100 text-purple-800",
                            random: "bg-green-100 text-green-800",
                            failover: "bg-orange-100 text-orange-800",
                        };
                        return classes[strategy] || "bg-gray-100 text-gray-800";
                    },

                    async viewGroupStats(keyId) {
                        try {
                            const response = await fetch(
                                `/admin/proxy-keys/${keyId}/group-stats`,
                            );
                            const result = await response.json();

                            if (result.success) {
                                // 显示统计信息的模态框或弹窗
                                let statsText = "分组使用统计:\n\n";
                                for (const [groupId, stats] of Object.entries(
                                    result.stats,
                                )) {
                                    statsText += `${this.getGroupName(groupId)}:\n`;
                                    statsText += `  使用次数: ${stats.usage_count}\n`;
                                    statsText += `  最后使用: ${stats.last_used ? this.formatDate(stats.last_used) : "从未使用"}\n\n`;
                                }
                                alert(statsText);
                            } else {
                                this.showMessage(
                                    "获取统计信息失败: " +
                                        (result.error || "未知错误"),
                                    "error",
                                );
                            }
                        } catch (error) {
                            console.error("获取分组统计失败:", error);
                            this.showMessage("网络错误，请检查连接", "error");
                        }
                    },

                    viewSystemLogs() {
                        window.location.href = "/logs";
                    },
                };
            }

            function logout() {
                fetch("/auth/logout", { method: "POST" })
                    .then((response) => {
                        if (response.ok) {
                            window.location.href = "/auth/login";
                        } else {
                            console.error("Logout failed");
                            window.location.href = "/auth/login";
                        }
                    })
                    .catch((error) => {
                        console.error("Logout error:", error);
                        window.location.href = "/auth/login";
                    });
            }
        </script>
    </body>
</html>
